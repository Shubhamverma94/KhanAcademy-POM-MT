"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("@appium/support");
var _bluebird = _interopRequireDefault(require("bluebird"));
var _events = _interopRequireDefault(require("events"));
var _teen_process = require("teen_process");
const {
  EventEmitter
} = _events.default;
const log = _support.logger.getLogger('Logcat');
const MAX_BUFFER_SIZE = 10000;
const LOGCAT_PROC_STARTUP_TIMEOUT = 10000;
const SUPPORTED_FORMATS = ['brief', 'process', 'tag', 'thread', 'raw', 'time', 'threadtime', 'long'];
const SUPPORTED_PRIORITIES = ['v', 'd', 'i', 'w', 'e', 'f', 's'];
const DEFAULT_PRIORITY = 'v';
const DEFAULT_TAG = '*';
const DEFAULT_FORMAT = 'threadtime';
function requireFormat(format) {
  if (!SUPPORTED_FORMATS.includes(format)) {
    log.info(`The format value '${format}' is unknown. Supported values are: ${SUPPORTED_FORMATS}`);
    log.info(`Defaulting to '${DEFAULT_FORMAT}'`);
    return DEFAULT_FORMAT;
  }
  return format;
}
function requireSpec(spec) {
  const [tag, priority] = spec.split(':');
  let resultTag = tag;
  if (!resultTag) {
    log.info(`The tag value in spec '${spec}' cannot be empty`);
    log.info(`Defaulting to '${DEFAULT_TAG}'`);
    resultTag = DEFAULT_TAG;
  }
  if (!priority) {
    log.info(`The priority value in spec '${spec}' is empty. Defaulting to Verbose (${DEFAULT_PRIORITY})`);
    return `${resultTag}:${DEFAULT_PRIORITY}`;
  }
  if (!SUPPORTED_PRIORITIES.some(p => _lodash.default.toLower(priority) === _lodash.default.toLower(p))) {
    log.info(`The priority value in spec '${spec}' is unknown. Supported values are: ${SUPPORTED_PRIORITIES}`);
    log.info(`Defaulting to Verbose (${DEFAULT_PRIORITY})`);
    return `${resultTag}:${DEFAULT_PRIORITY}`;
  }
  return spec;
}
function formatFilterSpecs(filterSpecs) {
  if (!_lodash.default.isArray(filterSpecs)) {
    filterSpecs = [filterSpecs];
  }
  return filterSpecs.filter(spec => spec && _lodash.default.isString(spec) && !spec.startsWith('-')).map(spec => spec.includes(':') ? requireSpec(spec) : spec);
}
class Logcat extends EventEmitter {
  constructor(opts = {}) {
    super();
    this.adb = opts.adb;
    this.clearLogs = opts.clearDeviceLogsOnStart || false;
    this.debug = opts.debug;
    this.debugTrace = opts.debugTrace;
    this.maxBufferSize = opts.maxBufferSize || MAX_BUFFER_SIZE;
    this.logs = [];
    this.logIdxSinceLastRequest = 0;
  }
  async startCapture(opts = {}) {
    let started = false;
    return await new _bluebird.default(async (_resolve, _reject) => {
      const resolve = function (...args) {
        started = true;
        _resolve(...args);
      };
      const reject = function (...args) {
        started = true;
        _reject(...args);
      };
      if (this.clearLogs) {
        await this.clear();
      }
      const {
        format = DEFAULT_FORMAT,
        filterSpecs = []
      } = opts;
      const cmd = [...this.adb.defaultArgs, 'logcat', '-v', requireFormat(format), ...formatFilterSpecs(filterSpecs)];
      log.debug(`Starting logs capture with command: ${_support.util.quote([this.adb.path, ...cmd])}`);
      this.proc = new _teen_process.SubProcess(this.adb.path, cmd);
      this.proc.on('exit', (code, signal) => {
        log.error(`Logcat terminated with code ${code}, signal ${signal}`);
        this.proc = null;
        if (!started) {
          log.warn('Logcat not started. Continuing');
          resolve();
        }
      });
      this.proc.on('lines-stderr', lines => {
        for (let line of lines) {
          if (/execvp\(\)/.test(line)) {
            log.error('Logcat process failed to start');
            reject(new Error(`Logcat process failed to start. stderr: ${line}`));
          }
          this.outputHandler(_lodash.default.trim(line), 'STDERR: ');
        }
        resolve();
      });
      this.proc.on('lines-stdout', lines => {
        resolve();
        for (let line of lines) {
          this.outputHandler(_lodash.default.trim(line));
        }
      });
      await this.proc.start(0);
      setTimeout(resolve, LOGCAT_PROC_STARTUP_TIMEOUT);
    });
  }
  outputHandler(output, prefix = '') {
    if (!output) {
      return;
    }
    if (this.logs.length >= this.maxBufferSize) {
      this.logs.shift();
      if (this.logIdxSinceLastRequest > 0) {
        --this.logIdxSinceLastRequest;
      }
    }
    const outputObj = {
      timestamp: Date.now(),
      level: 'ALL',
      message: output
    };
    this.logs.push(outputObj);
    this.emit('output', outputObj);
    const isTrace = /W\/Trace/.test(output);
    if (this.debug && (!isTrace || this.debugTrace)) {
      log.debug(prefix + output);
    }
  }
  async stopCapture() {
    log.debug('Stopping logcat capture');
    if (!this.proc || !this.proc.isRunning) {
      log.debug('Logcat already stopped');
      this.proc = null;
      return;
    }
    this.proc.removeAllListeners('exit');
    await this.proc.stop();
    this.proc = null;
  }
  getLogs() {
    if (this.logIdxSinceLastRequest < this.logs.length) {
      const result = this.logs.slice(this.logIdxSinceLastRequest);
      this.logIdxSinceLastRequest = this.logs.length;
      return result;
    }
    return [];
  }
  getAllLogs() {
    return this.logs;
  }
  async clear() {
    log.debug('Clearing logcat logs from device');
    try {
      const args = [...this.adb.defaultArgs, 'logcat', '-c'];
      await (0, _teen_process.exec)(this.adb.path, args);
    } catch (err) {
      log.warn(`Failed to clear logcat logs: ${err.stderr || err.message}`);
    }
  }
}
var _default = Logcat;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfc3VwcG9ydCIsIl9ibHVlYmlyZCIsIl9ldmVudHMiLCJfdGVlbl9wcm9jZXNzIiwiRXZlbnRFbWl0dGVyIiwiZXZlbnRzIiwibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTUFYX0JVRkZFUl9TSVpFIiwiTE9HQ0FUX1BST0NfU1RBUlRVUF9USU1FT1VUIiwiU1VQUE9SVEVEX0ZPUk1BVFMiLCJTVVBQT1JURURfUFJJT1JJVElFUyIsIkRFRkFVTFRfUFJJT1JJVFkiLCJERUZBVUxUX1RBRyIsIkRFRkFVTFRfRk9STUFUIiwicmVxdWlyZUZvcm1hdCIsImZvcm1hdCIsImluY2x1ZGVzIiwiaW5mbyIsInJlcXVpcmVTcGVjIiwic3BlYyIsInRhZyIsInByaW9yaXR5Iiwic3BsaXQiLCJyZXN1bHRUYWciLCJzb21lIiwicCIsIl8iLCJ0b0xvd2VyIiwiZm9ybWF0RmlsdGVyU3BlY3MiLCJmaWx0ZXJTcGVjcyIsImlzQXJyYXkiLCJmaWx0ZXIiLCJpc1N0cmluZyIsInN0YXJ0c1dpdGgiLCJtYXAiLCJMb2djYXQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJhZGIiLCJjbGVhckxvZ3MiLCJjbGVhckRldmljZUxvZ3NPblN0YXJ0IiwiZGVidWciLCJkZWJ1Z1RyYWNlIiwibWF4QnVmZmVyU2l6ZSIsImxvZ3MiLCJsb2dJZHhTaW5jZUxhc3RSZXF1ZXN0Iiwic3RhcnRDYXB0dXJlIiwic3RhcnRlZCIsIkIiLCJfcmVzb2x2ZSIsIl9yZWplY3QiLCJyZXNvbHZlIiwiYXJncyIsInJlamVjdCIsImNsZWFyIiwiY21kIiwiZGVmYXVsdEFyZ3MiLCJ1dGlsIiwicXVvdGUiLCJwYXRoIiwicHJvYyIsIlN1YlByb2Nlc3MiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJlcnJvciIsIndhcm4iLCJsaW5lcyIsImxpbmUiLCJ0ZXN0IiwiRXJyb3IiLCJvdXRwdXRIYW5kbGVyIiwidHJpbSIsInN0YXJ0Iiwic2V0VGltZW91dCIsIm91dHB1dCIsInByZWZpeCIsImxlbmd0aCIsInNoaWZ0Iiwib3V0cHV0T2JqIiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsImxldmVsIiwibWVzc2FnZSIsInB1c2giLCJlbWl0IiwiaXNUcmFjZSIsInN0b3BDYXB0dXJlIiwiaXNSdW5uaW5nIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwic3RvcCIsImdldExvZ3MiLCJyZXN1bHQiLCJzbGljZSIsImdldEFsbExvZ3MiLCJleGVjIiwiZXJyIiwic3RkZXJyIiwiX2RlZmF1bHQiLCJleHBvcnRzIiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9sb2djYXQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5jb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gZXZlbnRzO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0xvZ2NhdCcpO1xuY29uc3QgTUFYX0JVRkZFUl9TSVpFID0gMTAwMDA7XG5jb25zdCBMT0dDQVRfUFJPQ19TVEFSVFVQX1RJTUVPVVQgPSAxMDAwMDtcbmNvbnN0IFNVUFBPUlRFRF9GT1JNQVRTID0gWydicmllZicsICdwcm9jZXNzJywgJ3RhZycsICd0aHJlYWQnLCAncmF3JywgJ3RpbWUnLCAndGhyZWFkdGltZScsICdsb25nJ107XG5jb25zdCBTVVBQT1JURURfUFJJT1JJVElFUyA9IFsndicsICdkJywgJ2knLCAndycsICdlJywgJ2YnLCAncyddO1xuY29uc3QgREVGQVVMVF9QUklPUklUWSA9ICd2JztcbmNvbnN0IERFRkFVTFRfVEFHID0gJyonO1xuY29uc3QgREVGQVVMVF9GT1JNQVQgPSAndGhyZWFkdGltZSc7XG5cbmZ1bmN0aW9uIHJlcXVpcmVGb3JtYXQgKGZvcm1hdCkge1xuICBpZiAoIVNVUFBPUlRFRF9GT1JNQVRTLmluY2x1ZGVzKGZvcm1hdCkpIHtcbiAgICBsb2cuaW5mbyhgVGhlIGZvcm1hdCB2YWx1ZSAnJHtmb3JtYXR9JyBpcyB1bmtub3duLiBTdXBwb3J0ZWQgdmFsdWVzIGFyZTogJHtTVVBQT1JURURfRk9STUFUU31gKTtcbiAgICBsb2cuaW5mbyhgRGVmYXVsdGluZyB0byAnJHtERUZBVUxUX0ZPUk1BVH0nYCk7XG4gICAgcmV0dXJuIERFRkFVTFRfRk9STUFUO1xuICB9XG4gIHJldHVybiBmb3JtYXQ7XG59XG5cbmZ1bmN0aW9uIHJlcXVpcmVTcGVjIChzcGVjKSB7XG4gIGNvbnN0IFt0YWcsIHByaW9yaXR5XSA9IHNwZWMuc3BsaXQoJzonKTtcbiAgbGV0IHJlc3VsdFRhZyA9IHRhZztcbiAgaWYgKCFyZXN1bHRUYWcpIHtcbiAgICBsb2cuaW5mbyhgVGhlIHRhZyB2YWx1ZSBpbiBzcGVjICcke3NwZWN9JyBjYW5ub3QgYmUgZW1wdHlgKTtcbiAgICBsb2cuaW5mbyhgRGVmYXVsdGluZyB0byAnJHtERUZBVUxUX1RBR30nYCk7XG4gICAgcmVzdWx0VGFnID0gREVGQVVMVF9UQUc7XG4gIH1cbiAgaWYgKCFwcmlvcml0eSkge1xuICAgIGxvZy5pbmZvKGBUaGUgcHJpb3JpdHkgdmFsdWUgaW4gc3BlYyAnJHtzcGVjfScgaXMgZW1wdHkuIERlZmF1bHRpbmcgdG8gVmVyYm9zZSAoJHtERUZBVUxUX1BSSU9SSVRZfSlgKTtcbiAgICByZXR1cm4gYCR7cmVzdWx0VGFnfToke0RFRkFVTFRfUFJJT1JJVFl9YDtcbiAgfVxuICBpZiAoIVNVUFBPUlRFRF9QUklPUklUSUVTLnNvbWUoKHApID0+IF8udG9Mb3dlcihwcmlvcml0eSkgPT09IF8udG9Mb3dlcihwKSkpIHtcbiAgICBsb2cuaW5mbyhgVGhlIHByaW9yaXR5IHZhbHVlIGluIHNwZWMgJyR7c3BlY30nIGlzIHVua25vd24uIFN1cHBvcnRlZCB2YWx1ZXMgYXJlOiAke1NVUFBPUlRFRF9QUklPUklUSUVTfWApO1xuICAgIGxvZy5pbmZvKGBEZWZhdWx0aW5nIHRvIFZlcmJvc2UgKCR7REVGQVVMVF9QUklPUklUWX0pYCk7XG4gICAgcmV0dXJuIGAke3Jlc3VsdFRhZ306JHtERUZBVUxUX1BSSU9SSVRZfWA7XG4gIH1cbiAgcmV0dXJuIHNwZWM7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdEZpbHRlclNwZWNzIChmaWx0ZXJTcGVjcykge1xuICBpZiAoIV8uaXNBcnJheShmaWx0ZXJTcGVjcykpIHtcbiAgICBmaWx0ZXJTcGVjcyA9IFtmaWx0ZXJTcGVjc107XG4gIH1cbiAgcmV0dXJuIGZpbHRlclNwZWNzXG4gICAgLmZpbHRlcigoc3BlYykgPT4gc3BlYyAmJiBfLmlzU3RyaW5nKHNwZWMpICYmICFzcGVjLnN0YXJ0c1dpdGgoJy0nKSlcbiAgICAubWFwKChzcGVjKSA9PiBzcGVjLmluY2x1ZGVzKCc6JykgPyByZXF1aXJlU3BlYyhzcGVjKSA6IHNwZWMpO1xufVxuXG5cbmNsYXNzIExvZ2NhdCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYWRiID0gb3B0cy5hZGI7XG4gICAgdGhpcy5jbGVhckxvZ3MgPSBvcHRzLmNsZWFyRGV2aWNlTG9nc09uU3RhcnQgfHwgZmFsc2U7XG4gICAgdGhpcy5kZWJ1ZyA9IG9wdHMuZGVidWc7XG4gICAgdGhpcy5kZWJ1Z1RyYWNlID0gb3B0cy5kZWJ1Z1RyYWNlO1xuICAgIHRoaXMubWF4QnVmZmVyU2l6ZSA9IG9wdHMubWF4QnVmZmVyU2l6ZSB8fCBNQVhfQlVGRkVSX1NJWkU7XG4gICAgdGhpcy5sb2dzID0gW107XG4gICAgdGhpcy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0ID0gMDtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0Q2FwdHVyZSAob3B0cyA9IHt9KSB7XG4gICAgbGV0IHN0YXJ0ZWQgPSBmYWxzZTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKF9yZXNvbHZlLCBfcmVqZWN0KSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wYXJhbS1uYW1lc1xuICAgICAgY29uc3QgcmVzb2x2ZSA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgIHN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICBfcmVzb2x2ZSguLi5hcmdzKTtcbiAgICAgIH07XG4gICAgICBjb25zdCByZWplY3QgPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgICBzdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgX3JlamVjdCguLi5hcmdzKTtcbiAgICAgIH07XG5cbiAgICAgIGlmICh0aGlzLmNsZWFyTG9ncykge1xuICAgICAgICBhd2FpdCB0aGlzLmNsZWFyKCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHtcbiAgICAgICAgZm9ybWF0ID0gREVGQVVMVF9GT1JNQVQsXG4gICAgICAgIGZpbHRlclNwZWNzID0gW10sXG4gICAgICB9ID0gb3B0cztcbiAgICAgIGNvbnN0IGNtZCA9IFtcbiAgICAgICAgLi4udGhpcy5hZGIuZGVmYXVsdEFyZ3MsXG4gICAgICAgICdsb2djYXQnLFxuICAgICAgICAnLXYnLCByZXF1aXJlRm9ybWF0KGZvcm1hdCksXG4gICAgICAgIC4uLmZvcm1hdEZpbHRlclNwZWNzKGZpbHRlclNwZWNzKSxcbiAgICAgIF07XG4gICAgICBsb2cuZGVidWcoYFN0YXJ0aW5nIGxvZ3MgY2FwdHVyZSB3aXRoIGNvbW1hbmQ6ICR7dXRpbC5xdW90ZShbdGhpcy5hZGIucGF0aCwgLi4uY21kXSl9YCk7XG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2Vzcyh0aGlzLmFkYi5wYXRoLCBjbWQpO1xuICAgICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBsb2cuZXJyb3IoYExvZ2NhdCB0ZXJtaW5hdGVkIHdpdGggY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgICAgIGlmICghc3RhcnRlZCkge1xuICAgICAgICAgIGxvZy53YXJuKCdMb2djYXQgbm90IHN0YXJ0ZWQuIENvbnRpbnVpbmcnKTtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5wcm9jLm9uKCdsaW5lcy1zdGRlcnInLCAobGluZXMpID0+IHtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBsaW5lcykge1xuICAgICAgICAgIGlmICgvZXhlY3ZwXFwoXFwpLy50ZXN0KGxpbmUpKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoJ0xvZ2NhdCBwcm9jZXNzIGZhaWxlZCB0byBzdGFydCcpO1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgTG9nY2F0IHByb2Nlc3MgZmFpbGVkIHRvIHN0YXJ0LiBzdGRlcnI6ICR7bGluZX1gKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMub3V0cHV0SGFuZGxlcihfLnRyaW0obGluZSksICdTVERFUlI6ICcpO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5wcm9jLm9uKCdsaW5lcy1zdGRvdXQnLCAobGluZXMpID0+IHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICBmb3IgKGxldCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICAgICAgdGhpcy5vdXRwdXRIYW5kbGVyKF8udHJpbShsaW5lKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0YXJ0KDApO1xuICAgICAgLy8gcmVzb2x2ZSBhZnRlciBhIHRpbWVvdXQsIGV2ZW4gaWYgbm8gb3V0cHV0IHdhcyByZWNvcmRlZFxuICAgICAgc2V0VGltZW91dChyZXNvbHZlLCBMT0dDQVRfUFJPQ19TVEFSVFVQX1RJTUVPVVQpO1xuICAgIH0pO1xuICB9XG5cbiAgb3V0cHV0SGFuZGxlciAob3V0cHV0LCBwcmVmaXggPSAnJykge1xuICAgIGlmICghb3V0cHV0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubG9ncy5sZW5ndGggPj0gdGhpcy5tYXhCdWZmZXJTaXplKSB7XG4gICAgICB0aGlzLmxvZ3Muc2hpZnQoKTtcbiAgICAgIGlmICh0aGlzLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QgPiAwKSB7XG4gICAgICAgIC0tdGhpcy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0O1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBvdXRwdXRPYmogPSB7XG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICBsZXZlbDogJ0FMTCcsXG4gICAgICBtZXNzYWdlOiBvdXRwdXQsXG4gICAgfTtcbiAgICB0aGlzLmxvZ3MucHVzaChvdXRwdXRPYmopO1xuICAgIHRoaXMuZW1pdCgnb3V0cHV0Jywgb3V0cHV0T2JqKTtcbiAgICBjb25zdCBpc1RyYWNlID0gL1dcXC9UcmFjZS8udGVzdChvdXRwdXQpO1xuICAgIGlmICh0aGlzLmRlYnVnICYmICghaXNUcmFjZSB8fCB0aGlzLmRlYnVnVHJhY2UpKSB7XG4gICAgICBsb2cuZGVidWcocHJlZml4ICsgb3V0cHV0KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdG9wQ2FwdHVyZSAoKSB7XG4gICAgbG9nLmRlYnVnKCdTdG9wcGluZyBsb2djYXQgY2FwdHVyZScpO1xuICAgIGlmICghdGhpcy5wcm9jIHx8ICF0aGlzLnByb2MuaXNSdW5uaW5nKSB7XG4gICAgICBsb2cuZGVidWcoJ0xvZ2NhdCBhbHJlYWR5IHN0b3BwZWQnKTtcbiAgICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucHJvYy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4aXQnKTtcbiAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgpO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gIH1cblxuICBnZXRMb2dzICgpIHtcbiAgICBpZiAodGhpcy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0IDwgdGhpcy5sb2dzLmxlbmd0aCkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5sb2dzLnNsaWNlKHRoaXMubG9nSWR4U2luY2VMYXN0UmVxdWVzdCk7XG4gICAgICB0aGlzLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QgPSB0aGlzLmxvZ3MubGVuZ3RoO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0QWxsTG9ncyAoKSB7XG4gICAgcmV0dXJuIHRoaXMubG9ncztcbiAgfVxuXG4gIGFzeW5jIGNsZWFyICgpIHtcbiAgICBsb2cuZGVidWcoJ0NsZWFyaW5nIGxvZ2NhdCBsb2dzIGZyb20gZGV2aWNlJyk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSBbLi4udGhpcy5hZGIuZGVmYXVsdEFyZ3MsICdsb2djYXQnLCAnLWMnXTtcbiAgICAgIGF3YWl0IGV4ZWModGhpcy5hZGIucGF0aCwgYXJncyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRmFpbGVkIHRvIGNsZWFyIGxvZ2NhdCBsb2dzOiAke2Vyci5zdGRlcnIgfHwgZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IExvZ2NhdDtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQSxJQUFBQSxPQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxRQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxTQUFBLEdBQUFILHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBRyxPQUFBLEdBQUFKLHNCQUFBLENBQUFDLE9BQUE7QUFFQSxJQUFBSSxhQUFBLEdBQUFKLE9BQUE7QUFEQSxNQUFNO0VBQUVLO0FBQWEsQ0FBQyxHQUFHQyxlQUFNO0FBRy9CLE1BQU1DLEdBQUcsR0FBR0MsZUFBTSxD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