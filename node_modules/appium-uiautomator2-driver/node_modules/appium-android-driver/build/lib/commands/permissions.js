"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _driver = require("appium/driver");
var _bluebird = _interopRequireDefault(require("bluebird"));
var _utils = require("../utils");
const commands = {};
exports.commands = commands;
const ALL_PERMISSIONS_MAGIC = 'all';
const PM_ACTION = Object.freeze({
  GRANT: 'grant',
  REVOKE: 'revoke'
});
const APPOPS_ACTION = Object.freeze({
  ALLOW: 'allow',
  DENY: 'deny',
  IGNORE: 'ignore',
  DEFAULT: 'default'
});
const PERMISSION_TARGET = Object.freeze({
  PM: 'pm',
  APPOPS: 'appops'
});
const PERMISSIONS_TYPE = Object.freeze({
  DENIED: 'denied',
  GRANTED: 'granted',
  REQUESTED: 'requested'
});
async function changePermissionsViaPm(permissions, appPackage, action) {
  if (!_lodash.default.values(PM_ACTION).includes(action)) {
    throw new _driver.errors.InvalidArgumentError(`Unknown action '${action}'. ` + `Only ${JSON.stringify(_lodash.default.values(PM_ACTION))} actions are supported`);
  }
  let affectedPermissions = _lodash.default.isArray(permissions) ? permissions : [permissions];
  if (_lodash.default.toLower(permissions) === ALL_PERMISSIONS_MAGIC) {
    const dumpsys = await this.adb.shell(['dumpsys', 'package', appPackage]);
    const grantedPermissions = await this.adb.getGrantedPermissions(appPackage, dumpsys);
    if (action === PM_ACTION.GRANT) {
      const reqPermissons = await this.adb.getReqPermissions(appPackage, dumpsys);
      affectedPermissions = _lodash.default.difference(reqPermissons, grantedPermissions);
    } else {
      affectedPermissions = grantedPermissions;
    }
    if (_lodash.default.isEmpty(affectedPermissions)) {
      this.log.info(`'${appPackage}' contains no permissions to ${action}`);
      return;
    }
  }
  if (action === PM_ACTION.GRANT) {
    await this.adb.grantPermissions(appPackage, affectedPermissions);
  } else {
    await _bluebird.default.all(affectedPermissions.map(name => this.adb.revokePermission(appPackage, name)));
  }
}
async function changePermissionsViaAppops(permissions, appPackage, action) {
  if (!_lodash.default.values(APPOPS_ACTION).includes(action)) {
    throw new _driver.errors.InvalidArgumentError(`Unknown action '${action}'. ` + `Only ${JSON.stringify(_lodash.default.values(APPOPS_ACTION))} actions are supported`);
  }
  if (_lodash.default.toLower(permissions) === ALL_PERMISSIONS_MAGIC) {
    throw new _driver.errors.InvalidArgumentError(`'${ALL_PERMISSIONS_MAGIC}' permission is only supported for ` + `'${PERMISSION_TARGET.PM}' target. ` + `Check AppOpsManager.java from Android platform sources to get the full list of supported AppOps permissions`);
  }
  const promises = (_lodash.default.isArray(permissions) ? permissions : [permissions]).map(permission => this.adb.shell(['appops', 'set', appPackage, permission, action]));
  await _bluebird.default.all(promises);
}
commands.mobileChangePermissions = async function mobileChangePermissions(opts = {}) {
  const {
    permissions,
    appPackage = this.opts.appPackage,
    action = _lodash.default.toLower(opts.target) === PERMISSION_TARGET.APPOPS ? APPOPS_ACTION.ALLOW : PM_ACTION.GRANT,
    target = PERMISSION_TARGET.PM
  } = opts;
  if (_lodash.default.isNil(permissions)) {
    throw new _driver.errors.InvalidArgumentError(`'permissions' argument is required`);
  }
  if (_lodash.default.isEmpty(permissions)) {
    throw new _driver.errors.InvalidArgumentError(`'permissions' argument must not be empty`);
  }
  switch (_lodash.default.toLower(target)) {
    case PERMISSION_TARGET.PM:
      return await changePermissionsViaPm.bind(this)(permissions, appPackage, _lodash.default.toLower(action));
    case PERMISSION_TARGET.APPOPS:
      this.ensureFeatureEnabled(_utils.ADB_SHELL_FEATURE);
      return await changePermissionsViaAppops.bind(this)(permissions, appPackage, _lodash.default.toLower(action));
    default:
      throw new _driver.errors.InvalidArgumentError(`'target' argument must be one of: ${_lodash.default.values(PERMISSION_TARGET)}`);
  }
};
commands.mobileGetPermissions = async function mobileGetPermissions(opts = {}) {
  const {
    type = PERMISSIONS_TYPE.REQUESTED,
    appPackage = this.opts.appPackage
  } = opts;
  let actionFunc;
  switch (_lodash.default.toLower(type)) {
    case PERMISSIONS_TYPE.REQUESTED:
      actionFunc = pkg => this.adb.getReqPermissions(pkg);
      break;
    case PERMISSIONS_TYPE.GRANTED:
      actionFunc = pkg => this.adb.getGrantedPermissions(pkg);
      break;
    case PERMISSIONS_TYPE.DENIED:
      actionFunc = pkg => this.adb.getDeniedPermissions(pkg);
      break;
    default:
      throw new _driver.errors.InvalidArgumentError(`Unknown permissions type '${type}'. ` + `Only ${JSON.stringify(_lodash.default.values(PERMISSIONS_TYPE))} types are supported`);
  }
  return await actionFunc(appPackage);
};
var _default = commands;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZHJpdmVyIiwiX2JsdWViaXJkIiwiX3V0aWxzIiwiY29tbWFuZHMiLCJleHBvcnRzIiwiQUxMX1BFUk1JU1NJT05TX01BR0lDIiwiUE1fQUNUSU9OIiwiT2JqZWN0IiwiZnJlZXplIiwiR1JBTlQiLCJSRVZPS0UiLCJBUFBPUFNfQUNUSU9OIiwiQUxMT1ciLCJERU5ZIiwiSUdOT1JFIiwiREVGQVVMVCIsIlBFUk1JU1NJT05fVEFSR0VUIiwiUE0iLCJBUFBPUFMiLCJQRVJNSVNTSU9OU19UWVBFIiwiREVOSUVEIiwiR1JBTlRFRCIsIlJFUVVFU1RFRCIsImNoYW5nZVBlcm1pc3Npb25zVmlhUG0iLCJwZXJtaXNzaW9ucyIsImFwcFBhY2thZ2UiLCJhY3Rpb24iLCJfIiwidmFsdWVzIiwiaW5jbHVkZXMiLCJlcnJvcnMiLCJJbnZhbGlkQXJndW1lbnRFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJhZmZlY3RlZFBlcm1pc3Npb25zIiwiaXNBcnJheSIsInRvTG93ZXIiLCJkdW1wc3lzIiwiYWRiIiwic2hlbGwiLCJncmFudGVkUGVybWlzc2lvbnMiLCJnZXRHcmFudGVkUGVybWlzc2lvbnMiLCJyZXFQZXJtaXNzb25zIiwiZ2V0UmVxUGVybWlzc2lvbnMiLCJkaWZmZXJlbmNlIiwiaXNFbXB0eSIsImxvZyIsImluZm8iLCJncmFudFBlcm1pc3Npb25zIiwiQiIsImFsbCIsIm1hcCIsIm5hbWUiLCJyZXZva2VQZXJtaXNzaW9uIiwiY2hhbmdlUGVybWlzc2lvbnNWaWFBcHBvcHMiLCJwcm9taXNlcyIsInBlcm1pc3Npb24iLCJtb2JpbGVDaGFuZ2VQZXJtaXNzaW9ucyIsIm9wdHMiLCJ0YXJnZXQiLCJpc05pbCIsImJpbmQiLCJlbnN1cmVGZWF0dXJlRW5hYmxlZCIsIkFEQl9TSEVMTF9GRUFUVVJFIiwibW9iaWxlR2V0UGVybWlzc2lvbnMiLCJ0eXBlIiwiYWN0aW9uRnVuYyIsInBrZyIsImdldERlbmllZFBlcm1pc3Npb25zIiwiX2RlZmF1bHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2NvbW1hbmRzL3Blcm1pc3Npb25zLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0vZHJpdmVyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IEFEQl9TSEVMTF9GRUFUVVJFIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb25zdCBBTExfUEVSTUlTU0lPTlNfTUFHSUMgPSAnYWxsJztcbmNvbnN0IFBNX0FDVElPTiA9IE9iamVjdC5mcmVlemUoe1xuICBHUkFOVDogJ2dyYW50JyxcbiAgUkVWT0tFOiAncmV2b2tlJyxcbn0pO1xuY29uc3QgQVBQT1BTX0FDVElPTiA9IE9iamVjdC5mcmVlemUoe1xuICBBTExPVzogJ2FsbG93JyxcbiAgREVOWTogJ2RlbnknLFxuICBJR05PUkU6ICdpZ25vcmUnLFxuICBERUZBVUxUOiAnZGVmYXVsdCcsXG59KTtcbmNvbnN0IFBFUk1JU1NJT05fVEFSR0VUID0gT2JqZWN0LmZyZWV6ZSh7XG4gIFBNOiAncG0nLFxuICBBUFBPUFM6ICdhcHBvcHMnLFxufSk7XG5jb25zdCBQRVJNSVNTSU9OU19UWVBFID0gT2JqZWN0LmZyZWV6ZSh7XG4gIERFTklFRDogJ2RlbmllZCcsXG4gIEdSQU5URUQ6ICdncmFudGVkJyxcbiAgUkVRVUVTVEVEOiAncmVxdWVzdGVkJyxcbn0pO1xuXG5hc3luYyBmdW5jdGlvbiBjaGFuZ2VQZXJtaXNzaW9uc1ZpYVBtIChwZXJtaXNzaW9ucywgYXBwUGFja2FnZSwgYWN0aW9uKSB7XG4gIGlmICghXy52YWx1ZXMoUE1fQUNUSU9OKS5pbmNsdWRlcyhhY3Rpb24pKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgVW5rbm93biBhY3Rpb24gJyR7YWN0aW9ufScuIGAgK1xuICAgICAgYE9ubHkgJHtKU09OLnN0cmluZ2lmeShfLnZhbHVlcyhQTV9BQ1RJT04pKX0gYWN0aW9ucyBhcmUgc3VwcG9ydGVkYCk7XG4gIH1cblxuICBsZXQgYWZmZWN0ZWRQZXJtaXNzaW9ucyA9IF8uaXNBcnJheShwZXJtaXNzaW9ucykgPyBwZXJtaXNzaW9ucyA6IFtwZXJtaXNzaW9uc107XG4gIGlmIChfLnRvTG93ZXIocGVybWlzc2lvbnMpID09PSBBTExfUEVSTUlTU0lPTlNfTUFHSUMpIHtcbiAgICBjb25zdCBkdW1wc3lzID0gYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydkdW1wc3lzJywgJ3BhY2thZ2UnLCBhcHBQYWNrYWdlXSk7XG4gICAgY29uc3QgZ3JhbnRlZFBlcm1pc3Npb25zID0gYXdhaXQgdGhpcy5hZGIuZ2V0R3JhbnRlZFBlcm1pc3Npb25zKGFwcFBhY2thZ2UsIGR1bXBzeXMpO1xuICAgIGlmIChhY3Rpb24gPT09IFBNX0FDVElPTi5HUkFOVCkge1xuICAgICAgY29uc3QgcmVxUGVybWlzc29ucyA9IGF3YWl0IHRoaXMuYWRiLmdldFJlcVBlcm1pc3Npb25zKGFwcFBhY2thZ2UsIGR1bXBzeXMpO1xuICAgICAgYWZmZWN0ZWRQZXJtaXNzaW9ucyA9IF8uZGlmZmVyZW5jZShyZXFQZXJtaXNzb25zLCBncmFudGVkUGVybWlzc2lvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhZmZlY3RlZFBlcm1pc3Npb25zID0gZ3JhbnRlZFBlcm1pc3Npb25zO1xuICAgIH1cbiAgICBpZiAoXy5pc0VtcHR5KGFmZmVjdGVkUGVybWlzc2lvbnMpKSB7XG4gICAgICB0aGlzLmxvZy5pbmZvKGAnJHthcHBQYWNrYWdlfScgY29udGFpbnMgbm8gcGVybWlzc2lvbnMgdG8gJHthY3Rpb259YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgaWYgKGFjdGlvbiA9PT0gUE1fQUNUSU9OLkdSQU5UKSB7XG4gICAgYXdhaXQgdGhpcy5hZGIuZ3JhbnRQZXJtaXNzaW9ucyhhcHBQYWNrYWdlLCBhZmZlY3RlZFBlcm1pc3Npb25zKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBCLmFsbChhZmZlY3RlZFBlcm1pc3Npb25zLm1hcCgobmFtZSkgPT4gdGhpcy5hZGIucmV2b2tlUGVybWlzc2lvbihhcHBQYWNrYWdlLCBuYW1lKSkpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoYW5nZVBlcm1pc3Npb25zVmlhQXBwb3BzIChwZXJtaXNzaW9ucywgYXBwUGFja2FnZSwgYWN0aW9uKSB7XG4gIGlmICghXy52YWx1ZXMoQVBQT1BTX0FDVElPTikuaW5jbHVkZXMoYWN0aW9uKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYFVua25vd24gYWN0aW9uICcke2FjdGlvbn0nLiBgICtcbiAgICAgIGBPbmx5ICR7SlNPTi5zdHJpbmdpZnkoXy52YWx1ZXMoQVBQT1BTX0FDVElPTikpfSBhY3Rpb25zIGFyZSBzdXBwb3J0ZWRgKTtcbiAgfVxuICBpZiAoXy50b0xvd2VyKHBlcm1pc3Npb25zKSA9PT0gQUxMX1BFUk1JU1NJT05TX01BR0lDKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgJyR7QUxMX1BFUk1JU1NJT05TX01BR0lDfScgcGVybWlzc2lvbiBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgYCArXG4gICAgICBgJyR7UEVSTUlTU0lPTl9UQVJHRVQuUE19JyB0YXJnZXQuIGAgK1xuICAgICAgYENoZWNrIEFwcE9wc01hbmFnZXIuamF2YSBmcm9tIEFuZHJvaWQgcGxhdGZvcm0gc291cmNlcyB0byBnZXQgdGhlIGZ1bGwgbGlzdCBvZiBzdXBwb3J0ZWQgQXBwT3BzIHBlcm1pc3Npb25zYCk7XG4gIH1cblxuICBjb25zdCBwcm9taXNlcyA9IChfLmlzQXJyYXkocGVybWlzc2lvbnMpID8gcGVybWlzc2lvbnMgOiBbcGVybWlzc2lvbnNdKVxuICAgIC5tYXAoKHBlcm1pc3Npb24pID0+IHRoaXMuYWRiLnNoZWxsKFsnYXBwb3BzJywgJ3NldCcsIGFwcFBhY2thZ2UsIHBlcm1pc3Npb24sIGFjdGlvbl0pKTtcbiAgYXdhaXQgQi5hbGwocHJvbWlzZXMpO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENoYW5nZVBlcm1pc3Npb25zT3B0aW9uc1xuICogQHByb3BlcnR5IHshc3RyaW5nfEFycmF5PHN0cmluZz59IHBlcm1pc3Npb25zXG4gKiBJZiBgdGFyZ2V0YCBpcyBzZXQgdG8gJ3BtJzpcbiAqICAgVGhlIGZ1bGwgbmFtZSBvZiB0aGUgcGVybWlzc2lvbiB0byBiZSBjaGFuZ2VkXG4gKiBvciBhIGxpc3Qgb2YgcGVybWlzc2lvbnMuIENoZWNrIGh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9hbmRyb2lkL01hbmlmZXN0LnBlcm1pc3Npb25cbiAqIHRvIGdldCB0aGUgZnVsbCBsaXN0IG9mIHN0YW5kYXJkIEFuZHJvaWQgcGVybXNzaW9uIG5hbWVzLiBNYW5kYXRvcnkgYXJndW1lbnQuXG4gKiBJZiAnYWxsJyBtYWdpYyBzdHJpbmcgaXMgcGFzc2VkIHRoZW4gdGhlIGNob3NlbiBhY3Rpb24gaXMgZ29pbmcgdG8gYmUgYXBwbGllZCB0byBhbGxcbiAqIHBlcm1pc2lzb25zIHJlcXVlc3RlZC9ncmFudGVkIGJ5ICdhcHBQYWNrYWdlJy5cbiAqIElmIGB0YXJnZXRgIGlzIHNldCB0byAnYXBwb3BzJzpcbiAqICAgVGhlIGZ1bGwgbmFtZSBvZiB0aGUgYXBwb3BzIHBlcm1pc3Npb24gdG8gYmUgY2hhbmdlZFxuICogb3IgYSBsaXN0IG9mIHBlcm1pc3Npb25zLiBDaGVjayBBcHBPcHNNYW5hZ2VyLmphdmEgc291cmNlcyB0byBnZXQgdGhlIGZ1bGwgbGlzdCBvZlxuICogc3VwcG9ydGVkIGFwcG9wcyBwZXJtaXNzaW9uIG5hbWVzIGZvciB0aGUgZ2l2ZW4gQW5kcm9pZCBwa2xhdGZvcm0uXG4gKiBFeGFtcGxlczogJ0FDVElWSVRZX1JFQ09HTklUSU9OJywgJ1NNU19GSU5BTkNJQUxfVFJBTlNBQ1RJT05TJywgJ1JFQURfU01TJywgJ0FDQ0VTU19OT1RJRklDQVRJT05TJy5cbiAqIFRoZSAnYWxsJyBtYWdpYyBzdHJpbmcgaXMgdW5zdXBwb3J0ZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBwUGFja2FnZSBbdGhpcy5vcHRzLmFwcFBhY2thZ2VdIFRoZSBhcHBsaWNhdGlvbiBwYWNrYWdlIHRvIHNldCBjaGFuZ2VcbiAqIHBlcm1pc3Npb25zIG9uLiBEZWZhdWx0cyB0byB0aGUgcGFja2FnZSBuYW1lIHVuZGVyIHRlc3QuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYWN0aW9uIFtncmFudHxhbGxvd10gT25lIG9mIGBQTV9BQ1RJT05gIHZhbHVlcyBpZiBgdGFyZ2V0YCBpcyBzZXQgdG8gJ3BtJyxcbiAqIG90aGVyd2lzZSBvbmUgb2YgYEFQUE9QU19BQ1RJT05gIHZhbHVlc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHRhcmdldCBbcG1dIEVpdGhlciAncG0nIG9yICdhcHBvcHMnLiBUaGUgJ2FwcG9wcycgb25lIHJlcXVpcmVzXG4gKiAnYWRiX3NoZWxsJyBzZXJ2ZXIgc2VjdXJpdHkgb3B0aW9uIHRvIGJlIGVuYWJsZWQuXG4gKi9cblxuLyoqXG4gKiBDaGFuZ2VzIHBhY2thZ2UgcGVybWlzc2lvbnMgaW4gcnVudGltZS5cbiAqXG4gKiBAcGFyYW0gez9DaGFuZ2VQZXJtaXNzaW9uc09wdGlvbnN9IG9wdHMgLSBBdmFpbGFibGUgb3B0aW9ucyBtYXBwaW5nLlxuICogQHRocm93cyB7RXJyb3J9IGlmIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUgY2hhbmdpbmcgcGVybWlzc2lvbnNcbiAqL1xuY29tbWFuZHMubW9iaWxlQ2hhbmdlUGVybWlzc2lvbnMgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVDaGFuZ2VQZXJtaXNzaW9ucyAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBwZXJtaXNzaW9ucyxcbiAgICBhcHBQYWNrYWdlID0gdGhpcy5vcHRzLmFwcFBhY2thZ2UsXG4gICAgYWN0aW9uID0gXy50b0xvd2VyKG9wdHMudGFyZ2V0KSA9PT0gUEVSTUlTU0lPTl9UQVJHRVQuQVBQT1BTID8gQVBQT1BTX0FDVElPTi5BTExPVyA6IFBNX0FDVElPTi5HUkFOVCxcbiAgICB0YXJnZXQgPSBQRVJNSVNTSU9OX1RBUkdFVC5QTSxcbiAgfSA9IG9wdHM7XG4gIGlmIChfLmlzTmlsKHBlcm1pc3Npb25zKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYCdwZXJtaXNzaW9ucycgYXJndW1lbnQgaXMgcmVxdWlyZWRgKTtcbiAgfVxuICBpZiAoXy5pc0VtcHR5KHBlcm1pc3Npb25zKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYCdwZXJtaXNzaW9ucycgYXJndW1lbnQgbXVzdCBub3QgYmUgZW1wdHlgKTtcbiAgfVxuXG4gIHN3aXRjaCAoXy50b0xvd2VyKHRhcmdldCkpIHtcbiAgICBjYXNlIFBFUk1JU1NJT05fVEFSR0VULlBNOlxuICAgICAgcmV0dXJuIGF3YWl0IGNoYW5nZVBlcm1pc3Npb25zVmlhUG0uYmluZCh0aGlzKShwZXJtaXNzaW9ucywgYXBwUGFja2FnZSwgXy50b0xvd2VyKGFjdGlvbikpO1xuICAgIGNhc2UgUEVSTUlTU0lPTl9UQVJHRVQuQVBQT1BTOlxuICAgICAgdGhpcy5lbnN1cmVGZWF0dXJlRW5hYmxlZChBREJfU0hFTExfRkVBVFVSRSk7XG4gICAgICByZXR1cm4gYXdhaXQgY2hhbmdlUGVybWlzc2lvbnNWaWFBcHBvcHMuYmluZCh0aGlzKShwZXJtaXNzaW9ucywgYXBwUGFja2FnZSwgXy50b0xvd2VyKGFjdGlvbikpO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKGAndGFyZ2V0JyBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZjogJHtfLnZhbHVlcyhQRVJNSVNTSU9OX1RBUkdFVCl9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gR2V0UGVybWlzc2lvbnNPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gdHlwZSBbcmVxdWVzdGVkXSAtIE9uZSBvZiBwb3NzaWJsZSBwZXJtaXNzaW9uIHR5cGVzIHRvIGdldC5cbiAqIENhbiBiZSBhbnkgb2YgYFBFUk1JU1NJT05TX1RZUEVgIHZhbHVlcy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBhcHBQYWNrYWdlIFt0aGlzLm9wdHMuYXBwUGFja2FnZV0gLSBUaGUgYXBwbGljYXRpb24gcGFja2FnZSB0byBzZXQgY2hhbmdlXG4gKiBwZXJtaXNzaW9ucyBvbi4gRGVmYXVsdHMgdG8gdGhlIHBhY2thZ2UgbmFtZSB1bmRlciB0ZXN0LlxuICovXG5cbi8qKlxuICogR2V0cyBydW50aW1lIHBlcm1pc3Npb25zIGxpc3QgZm9yIHRoZSBnaXZlbiBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICpcbiAqIEBwYXJhbSB7R2V0UGVybWlzc2lvbnNPcHRpb25zfSBvcHRzIC0gQXZhaWxhYmxlIG9wdGlvbnMgbWFwcGluZy5cbiAqIEByZXR1cm5zIHtBcnJheTxzdHJpbmc+fSBUaGUgbGlzdCBvZiByZXRyaWV2ZWQgcGVybWlzc2lvbnMgZm9yIHRoZSBnaXZlbiB0eXBlXG4gKiAoY2FuIGFsc28gYmUgZW1wdHkpLlxuICogQHRocm93cyB7RXJyb3J9IGlmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHBlcm1pc3Npb25zLlxuICovXG5jb21tYW5kcy5tb2JpbGVHZXRQZXJtaXNzaW9ucyA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUdldFBlcm1pc3Npb25zIChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHR5cGUgPSBQRVJNSVNTSU9OU19UWVBFLlJFUVVFU1RFRCxcbiAgICBhcHBQYWNrYWdlID0gdGhpcy5vcHRzLmFwcFBhY2thZ2UsXG4gIH0gPSBvcHRzO1xuXG4gIGxldCBhY3Rpb25GdW5jO1xuICBzd2l0Y2ggKF8udG9Mb3dlcih0eXBlKSkge1xuICAgIGNhc2UgUEVSTUlTU0lPTlNfVFlQRS5SRVFVRVNURUQ6XG4gICAgICBhY3Rpb25GdW5jID0gKHBrZykgPT4gdGhpcy5hZGIuZ2V0UmVxUGVybWlzc2lvbnMocGtnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUEVSTUlTU0lPTlNfVFlQRS5HUkFOVEVEOlxuICAgICAgYWN0aW9uRnVuYyA9IChwa2cpID0+IHRoaXMuYWRiLmdldEdyYW50ZWRQZXJtaXNzaW9ucyhwa2cpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBQRVJNSVNTSU9OU19UWVBFLkRFTklFRDpcbiAgICAgIGFjdGlvbkZ1bmMgPSAocGtnKSA9PiB0aGlzLmFkYi5nZXREZW5pZWRQZXJtaXNzaW9ucyhwa2cpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYFVua25vd24gcGVybWlzc2lvbnMgdHlwZSAnJHt0eXBlfScuIGAgK1xuICAgICAgICBgT25seSAke0pTT04uc3RyaW5naWZ5KF8udmFsdWVzKFBFUk1JU1NJT05TX1RZUEUpKX0gdHlwZXMgYXJlIHN1cHBvcnRlZGApO1xuICB9XG4gIHJldHVybiBhd2FpdCBhY3Rpb25GdW5jKGFwcFBhY2thZ2UpO1xufTtcblxuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLE9BQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLFNBQUEsR0FBQUgsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFHLE1BQUEsR0FBQUgsT0FBQTtBQUVBLE1BQU1JLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFBQ0MsT0FBQSxDQUFBRCxRQUFBLEdBQUFBLFFBQUE7QUFFcEIsTUFBTUUscUJBQXFCLEdBQUcsS0FBSztBQUNuQyxNQUFNQyxTQUFTLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDO0VBQzlCQyxLQUFLLEVBQUUsT0FBTztFQUNkQyxNQUFNLEVBQUU7QUFDVixDQUFDLENBQUM7QUFDRixNQUFNQyxhQUFhLEdBQUdKLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDO0VBQ2xDSSxLQUFLLEVBQUUsT0FBTztFQUNkQyxJQUFJLEVBQUUsTUFBTTtFQUNaQyxNQUFNLEVBQUUsUUFBUTtFQUNoQkMsT0FBTyxFQUFFO0FBQ1gsQ0FBQyxDQUFDO0FBQ0YsTUFBTUMsaUJBQWlCLEdBQUdULE1BQU0sQ0FBQ0MsTUFBTSxDQUFDO0VBQ3RDUyxFQUFFLEVBQUUsSUFBSTtFQUNSQyxNQUFNLEVBQUU7QUFDVixDQUFDLENBQUM7QUFDRixNQUFNQyxnQkFBZ0IsR0FBR1osTUFBTSxDQUFDQyxNQUFNLENBQUM7RUFDckNZLE1BQU0sRUFBRSxRQUFRO0VBQ2hCQyxPQUFPLEVBQUUsU0FBUztFQUNsQkMsU0FBUyxFQUFFO0FBQ2IsQ0FBQyxDQUFDO0FBRUYsZUFBZUMsc0JBQXNCQSxDQUFFQyxXQUFXLEVBQUVDLFVBQVUsRUFBRUMsTUFBTSxFQUFFO0VBQ3RFLElBQUksQ0FBQ0MsZUFBQyxDQUFDQyxNQUFNLENBQUN0QixTQUFTLENBQUMsQ0FBQ3VCLFFBQVEsQ0FBQ0gsTUFBTSxDQUFDLEVBQUU7SUFDekMsTUFBTSxJQUFJSSxjQUFNLENBQUNDLG9CQUFvQixDQUFFLG1CQUFrQkwsTUFBTyxLQUFJLEdBQ2pFLFFBQU9NLElBQUksQ0FBQ0MsU0FBUyxDQUFDTixlQUFDLENBQUNDLE1BQU0sQ0FBQ3RCLFNBQVMsQ0FBQyxDQUFFLHdCQUF1QixDQUFDO0VBQ3hFO0VBRUEsSUFBSTRCLG1CQUFtQixHQUFHUCxlQUFDLENBQUNRLE9BQU8sQ0FBQ1gsV0FBVyxDQUFDLEdBQUdBLFdBQVcsR0FBRyxDQUFDQSxXQUFXLENBQUM7RUFDOUUsSUFBSUcsZUFBQyxDQUFDUyxPQUFPLENBQUNaLFdBQVcsQ0FBQyxLQUFLbkIscUJBQXFCLEVBQUU7SUFDcEQsTUFBTWdDLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQ0MsR0FBRyxDQUFDQyxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFZCxVQUFVLENBQUMsQ0FBQztJQUN4RSxNQUFNZSxrQkFBa0IsR0FBRyxNQUFNLElBQUksQ0FBQ0YsR0FBRyxDQUFDRyxxQkFBcUIsQ0FBQ2hCLFVBQVUsRUFBRVksT0FBTyxDQUFDO0lBQ3BGLElBQUlYLE1BQU0sS0FBS3BCLFNBQVMsQ0FBQ0csS0FBSyxFQUFFO01BQzlCLE1BQU1pQyxhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUNKLEdBQUcsQ0FBQ0ssaUJBQWlCLENBQUNsQixVQUFVLEVBQUVZLE9BQU8sQ0FBQztNQUMzRUgsbUJBQW1CLEdBQUdQLGVBQUMsQ0FBQ2lCLFVBQVUsQ0FBQ0YsYUFBYSxFQUFFRixrQkFBa0IsQ0FBQztJQUN2RSxDQUFDLE1BQU07TUFDTE4sbUJBQW1CLEdBQUdNLGtCQUFrQjtJQUMxQztJQUNBLElBQUliLGVBQUMsQ0FBQ2tCLE9BQU8sQ0FBQ1gsbUJBQW1CLENBQUMsRUFBRTtNQUNsQyxJQUFJLENBQUNZLEdBQUcsQ0FBQ0MsSUFBSSxDQUFFLElBQUd0QixVQUFXLGdDQUErQkMsTUFBTyxFQUFDLENBQUM7TUFDckU7SUFDRjtFQUNGO0VBRUEsSUFBSUEsTUFBTSxLQUFLcEIsU0FBUyxDQUFDRyxLQUFLLEVBQUU7SUFDOUIsTUFBTSxJQUFJLENBQUM2QixHQUFHLENBQUNVLGdCQUFnQixDQUFDdkIsVUFBVSxFQUFFUyxtQkFBbUIsQ0FBQztFQUNsRSxDQUFDLE1BQU07SUFDTCxNQUFNZSxpQkFBQyxDQUFDQyxHQUFHLENBQUNoQixtQkFBbUIsQ0FBQ2lCLEdBQUcsQ0FBRUMsSUFBSSxJQUFLLElBQUksQ0FBQ2QsR0FBRyxDQUFDZSxnQkFBZ0IsQ0FBQzVCLFVBQVUsRUFBRTJCLElBQUksQ0FBQyxDQUFDLENBQUM7RUFDN0Y7QUFDRjtBQUVBLGVBQWVFLDBCQUEwQkEsQ0FBRTlCLFdBQVcsRUFBRUMsVUFBVSxFQUFFQyxNQUFNLEVBQUU7RUFDMUUsSUFBSSxDQUFDQyxlQUFDLENBQUNDLE1BQU0sQ0FBQ2pCLGFBQWEsQ0FBQyxDQUFDa0IsUUFBUSxDQUFDSCxNQUFNLENBQUMsRUFBRTtJQUM3QyxNQUFNLElBQUlJLGNBQU0sQ0FBQ0Msb0JBQW9CLENBQUUsbUJBQWtCTCxNQUFPLEtBQUksR0FDakUsUUFBT00sSUFBSSxDQUFDQyxTQUFTLENBQUNOLGVBQUMsQ0FBQ0MsTUFBTSxDQUFDakIsYUFBYSxDQUFDLENBQUUsd0JBQXVCLENBQUM7RUFDNUU7RUFDQSxJQUFJZ0IsZUFBQyxDQUFDUyxPQUFPLENBQUNaLFdBQVcsQ0FBQyxLQUFLbkIscUJBQXFCLEVBQUU7SUFDcEQsTUFBTSxJQUFJeUIsY0FBTSxDQUFDQyxvQkFBb0IsQ0FBRSxJQUFHMUIscUJBQXNCLHFDQUFvQyxHQUNqRyxJQUFHVyxpQkFBaUIsQ0FBQ0MsRUFBRyxZQUFXLEdBQ25DLDZHQUE0RyxDQUFDO0VBQ2xIO0VBRUEsTUFBTXNDLFFBQVEsR0FBRyxDQUFDNUIsZUFBQyxDQUFDUSxPQUFPLENBQUNYLFdBQVcsQ0FBQyxHQUFHQSxXQUFXLEdBQUcsQ0FBQ0EsV0FBVyxDQUFDLEVBQ25FMkIsR0FBRyxDQUFFSyxVQUFVLElBQUssSUFBSSxDQUFDbEIsR0FBRyxDQUFDQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFZCxVQUFVLEVBQUUrQixVQUFVLEVBQUU5QixNQUFNLENBQUMsQ0FBQyxDQUFDO0VBQ3pGLE1BQU11QixpQkFBQyxDQUFDQyxHQUFHLENBQUNLLFFBQVEsQ0FBQztBQUN2QjtBQStCQXBELFFBQVEsQ0FBQ3NELHVCQUF1QixHQUFHLGVBQWVBLHVCQUF1QkEsQ0FBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3BGLE1BQU07SUFDSmxDLFdBQVc7SUFDWEMsVUFBVSxHQUFHLElBQUksQ0FBQ2lDLElBQUksQ0FBQ2pDLFVBQVU7SUFDakNDLE1BQU0sR0FBR0MsZUFBQyxDQUFDUyxPQUFPLENBQUNzQixJQUFJLENBQUNDLE1BQU0sQ0FBQyxLQUFLM0MsaUJBQWlCLENBQUNFLE1BQU0sR0FBR1AsYUFBYSxDQUFDQyxLQUFLLEdBQUdOLFNBQVMsQ0FBQ0csS0FBSztJQUNwR2tELE1BQU0sR0FBRzNDLGlCQUFpQixDQUFDQztFQUM3QixDQUFDLEdBQUd5QyxJQUFJO0VBQ1IsSUFBSS9CLGVBQUMsQ0FBQ2lDLEtBQUssQ0FBQ3BDLFdBQVcsQ0FBQyxFQUFFO0lBQ3hCLE1BQU0sSUFBSU0sY0FBTSxDQUFDQyxvQkFBb0IsQ0FBRSxvQ0FBbUMsQ0FBQztFQUM3RTtFQUNBLElBQUlKLGVBQUMsQ0FBQ2tCLE9BQU8sQ0FBQ3JCLFdBQVcsQ0FBQyxFQUFFO0lBQzFCLE1BQU0sSUFBSU0sY0FBTSxDQUFDQyxvQkFBb0IsQ0FBRSwwQ0FBeUMsQ0FBQztFQUNuRjtFQUVBLFFBQVFKLGVBQUMsQ0FBQ1MsT0FBTyxDQUFDdUIsTUFBTSxDQUFDO0lBQ3ZCLEtBQUszQyxpQkFBaUIsQ0FBQ0MsRUFBRTtNQUN2QixPQUFPLE1BQU1NLHNCQUFzQixDQUFDc0MsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDckMsV0FBVyxFQUFFQyxVQUFVLEVBQUVFLGVBQUMsQ0FBQ1MsT0FBTyxDQUFDVixNQUFNLENBQUMsQ0FBQztJQUM1RixLQUFLVixpQkFBaUIsQ0FBQ0UsTUFBTTtNQUMzQixJQUFJLENBQUM0QyxvQkFBb0IsQ0FBQ0Msd0JBQWlCLENBQUM7TUFDNUMsT0FBTyxNQUFNVCwwQkFBMEIsQ0FBQ08sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDckMsV0FBVyxFQUFFQyxVQUFVLEVBQUVFLGVBQUMsQ0FBQ1MsT0FBTyxDQUFDVixNQUFNLENBQUMsQ0FBQztJQUNoRztNQUNFLE1BQU0sSUFBSUksY0FBTSxDQUFDQyxvQkFBb0IsQ0FBRSxxQ0FBb0NKLGVBQUMsQ0FBQ0MsTUFBTSxDQUFDWixpQkFBaUIsQ0FBRSxFQUFDLENBQUM7RUFDN0c7QUFDRixDQUFDO0FBa0JEYixRQUFRLENBQUM2RCxvQkFBb0IsR0FBRyxlQUFlQSxvQkFBb0JBLENBQUVOLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUM5RSxNQUFNO0lBQ0pPLElBQUksR0FBRzlDLGdCQUFnQixDQUFDRyxTQUFTO0lBQ2pDRyxVQUFVLEdBQUcsSUFBSSxDQUFDaUMsSUFBSSxDQUFDakM7RUFDekIsQ0FBQyxHQUFHaUMsSUFBSTtFQUVSLElBQUlRLFVBQVU7RUFDZCxRQUFRdkMsZUFBQyxDQUFDUyxPQUFPLENBQUM2QixJQUFJLENBQUM7SUFDckIsS0FBSzlDLGdCQUFnQixDQUFDRyxTQUFTO01BQzdCNEMsVUFBVSxHQUFJQyxHQUFHLElBQUssSUFBSSxDQUFDN0IsR0FBRyxDQUFDSyxpQkFBaUIsQ0FBQ3dCLEdBQUcsQ0FBQztNQUNyRDtJQUNGLEtBQUtoRCxnQkFBZ0IsQ0FBQ0UsT0FBTztNQUMzQjZDLFVBQVUsR0FBSUMsR0FBRyxJQUFLLElBQUksQ0FBQzdCLEdBQUcsQ0FBQ0cscUJBQXFCLENBQUMwQixHQUFHLENBQUM7TUFDekQ7SUFDRixLQUFLaEQsZ0JBQWdCLENBQUNDLE1BQU07TUFDMUI4QyxVQUFVLEdBQUlDLEdBQUcsSUFBSyxJQUFJLENBQUM3QixHQUFHLENBQUM4QixvQkFBb0IsQ0FBQ0QsR0FBRyxDQUFDO01BQ3hEO0lBQ0Y7TUFDRSxNQUFNLElBQUlyQyxjQUFNLENBQUNDLG9CQUFvQixDQUFFLDZCQUE0QmtDLElBQUssS0FBSSxHQUN6RSxRQUFPakMsSUFBSSxDQUFDQyxTQUFTLENBQUNOLGVBQUMsQ0FBQ0MsTUFBTSxDQUFDVCxnQkFBZ0IsQ0FBQyxDQUFFLHNCQUFxQixDQUFDO0VBQy9FO0VBQ0EsT0FBTyxNQUFNK0MsVUFBVSxDQUFDekMsVUFBVSxDQUFDO0FBQ3JDLENBQUM7QUFBQyxJQUFBNEMsUUFBQSxHQUdhbEUsUUFBUTtBQUFBQyxPQUFBLENBQUFrRSxPQUFBLEdBQUFELFFBQUEifQ==