{"version":3,"file":"uiautomator.js","names":["_events","_interopRequireDefault","require","_support","log","logger","getLogger","UiAutomator","events","EventEmitter","constructor","adb","errorAndThrow","tempPath","start","uiAutomatorBinaryPath","className","startDetector","extraParams","processIsAlive","debug","changeState","STATE_STARTING","jarName","parseJarNameFromPath","push","killUiAutomatorOnDevice","args","proc","createSubProcess","on","code","signal","state","STATE_STOPPED","STATE_STOPPING","msg","error","STATE_ONLINE","e","emit","EVENT_ERROR","stop","shutdown","binaryPath","reTest","exec","Error","EVENT_CHANGED","killProcessesByName","warn","exports","_default","default"],"sources":["../../lib/uiautomator.js"],"sourcesContent":["import events from 'events';\nimport { logger } from '@appium/support';\n\n\nconst log = logger.getLogger('UiAutomator');\n\nclass UiAutomator extends events.EventEmitter {\n  constructor (adb) {\n    if (!adb) {\n      log.errorAndThrow('adb is required to instantiate UiAutomator');\n    }\n    super();\n    this.adb = adb;\n    this.tempPath = '/data/local/tmp/';\n  }\n\n  async start (uiAutomatorBinaryPath, className, startDetector, ...extraParams) {\n    let processIsAlive;\n    try {\n      log.debug('Starting UiAutomator');\n      this.changeState(UiAutomator.STATE_STARTING);\n\n      log.debug('Parsing uiautomator jar');\n      // expecting a path like /ads/ads/foo.jar or \\asd\\asd\\foo.jar\n      let jarName = this.parseJarNameFromPath(uiAutomatorBinaryPath);\n      await this.adb.push(uiAutomatorBinaryPath, this.tempPath);\n\n      // killing any uiautomator existing processes\n      await this.killUiAutomatorOnDevice();\n\n      log.debug('Starting UIAutomator');\n      let args = ['shell', 'uiautomator', 'runtest', jarName, '-c', className, ...extraParams];\n      this.proc = this.adb.createSubProcess(args);\n\n      // handle out-of-bound exit by simply emitting a stopped state\n      this.proc.on('exit', (code, signal) => {\n        processIsAlive = false;\n        // cleanup\n        if (this.state !== UiAutomator.STATE_STOPPED &&\n            this.state !== UiAutomator.STATE_STOPPING) {\n          let msg = `UiAutomator exited unexpectedly with code ${code}, ` +\n                    `signal ${signal}`;\n          log.error(msg);\n        } else if (this.state === UiAutomator.STATE_STOPPING) {\n          log.debug('UiAutomator shut down normally');\n        }\n        this.changeState(UiAutomator.STATE_STOPPED);\n      });\n\n      await this.proc.start(startDetector);\n      processIsAlive = true;\n      this.changeState(UiAutomator.STATE_ONLINE);\n      return this.proc;\n    } catch (e) {\n      this.emit(UiAutomator.EVENT_ERROR, e);\n      if (processIsAlive) {\n        await this.killUiAutomatorOnDevice();\n        await this.proc.stop();\n      }\n      log.errorAndThrow(e);\n    }\n  }\n\n  async shutdown () {\n    log.debug('Shutting down UiAutomator');\n    if (this.state !== UiAutomator.STATE_STOPPED) {\n      this.changeState(UiAutomator.STATE_STOPPING);\n      await this.proc.stop();\n    }\n    await this.killUiAutomatorOnDevice();\n    this.changeState(UiAutomator.STATE_STOPPED);\n  }\n\n  parseJarNameFromPath (binaryPath) {\n    let reTest = /.*(\\/|\\\\)(.*\\.jar)/.exec(binaryPath);\n    if (!reTest) {\n      throw new Error(`Unable to parse jar name from ${binaryPath}`);\n    }\n    let jarName = reTest[2];\n    log.debug(`Found jar name: '${jarName}'`);\n    return jarName;\n  }\n\n  changeState (state) {\n    log.debug(`Moving to state '${state}'`);\n    this.state = state;\n    this.emit(UiAutomator.EVENT_CHANGED, {state});\n  }\n\n  async killUiAutomatorOnDevice () {\n    try {\n      await this.adb.killProcessesByName('uiautomator');\n    } catch (e) {\n      log.warn(`Error while killing uiAutomator: ${e}`);\n    }\n  }\n\n}\n\nUiAutomator.EVENT_ERROR = 'uiautomator_error';\nUiAutomator.EVENT_CHANGED = 'stateChanged';\nUiAutomator.STATE_STOPPING = 'stopping';\nUiAutomator.STATE_STOPPED = 'stopped';\nUiAutomator.STATE_STARTING = 'starting';\nUiAutomator.STATE_ONLINE = 'online';\n\n\nexport { UiAutomator };\nexport default UiAutomator;\n"],"mappings":"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"}