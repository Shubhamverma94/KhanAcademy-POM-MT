"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SubProcess = void 0;

require("source-map-support/register");

var _child_process = require("child_process");

var _events = _interopRequireDefault(require("events"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _shellQuote = require("shell-quote");

var _lodash = _interopRequireDefault(require("lodash"));

var _helpers = require("./helpers");

const {
  EventEmitter
} = _events.default;
const MAX_LINE_PORTION_LENGTH = 0xFFFF;

function cutSuffix(str, suffixLength) {
  return str.length > suffixLength ? ` ${str.substr(str.length - suffixLength)}`.substr(1) : str;
}

class SubProcess extends EventEmitter {
  lastLinePortion;
  proc;
  args;
  cmd;
  opts;
  expectingExit;
  rep;

  constructor(cmd, args = [], opts = {}) {
    super();
    if (!cmd) throw new Error('Command is required');
    if (!_lodash.default.isString(cmd)) throw new Error('Command must be a string');
    if (!_lodash.default.isArray(args)) throw new Error('Args must be an array');
    this.cmd = cmd;
    this.args = args;
    this.proc = null;
    this.opts = opts;
    this.expectingExit = false;
    this.rep = (0, _shellQuote.quote)([cmd, ...args]);
    this.lastLinePortion = {
      stdout: '',
      stderr: ''
    };
  }

  get isRunning() {
    return !!this.proc;
  }

  emitLines(stream, lines) {
    for (let line of lines) {
      this.emit('stream-line', `[${stream.toUpperCase()}] ${line}`);
    }
  }

  async start(startDetector = null, timeoutMs = null, detach = false) {
    let startDelay = 10;

    const genericStartDetector = function genericStartDetector(stdout, stderr) {
      return stdout || stderr;
    };

    if (startDetector === null) {
      startDetector = genericStartDetector;
    }

    if (_lodash.default.isNumber(startDetector)) {
      startDelay = startDetector;
      startDetector = null;
    }

    if (_lodash.default.isBoolean(startDetector) && startDetector) {
      if (!this.opts.detached) {
        throw new Error(`Unable to detach process that is not started with 'detached' option`);
      }

      detach = true;
      startDetector = genericStartDetector;
    } else if (_lodash.default.isBoolean(timeoutMs) && timeoutMs) {
      if (!this.opts.detached) {
        throw new Error(`Unable to detach process that is not started with 'detached' option`);
      }

      detach = true;
      timeoutMs = null;
    }

    return await new _bluebird.default((resolve, reject) => {
      this.proc = (0, _child_process.spawn)(this.cmd, this.args, this.opts);

      if (this.proc.stdout) {
        this.proc.stdout.setEncoding(this.opts.encoding || 'utf8');
      }

      if (this.proc.stderr) {
        this.proc.stderr.setEncoding(this.opts.encoding || 'utf8');
      }

      this.lastLinePortion = {
        stdout: '',
        stderr: ''
      };

      const handleOutput = streams => {
        const {
          stdout,
          stderr
        } = streams;

        try {
          if (_lodash.default.isFunction(startDetector) && startDetector(stdout, stderr)) {
            startDetector = null;
            resolve();
          }
        } catch (e) {
          reject(e);
        }

        this.emit('output', stdout, stderr);

        for (const [streamName, streamData] of _lodash.default.toPairs(streams)) {
          if (!streamData) continue;
          const lines = streamData.split('\n').map(x => ` ${x}`.substr(1));

          if (lines.length > 1) {
            lines[0] = this.lastLinePortion[streamName] + lines[0];
            this.lastLinePortion[streamName] = cutSuffix(_lodash.default.last(lines), MAX_LINE_PORTION_LENGTH);
            const resultLines = lines.slice(0, -1);
            this.emit(`lines-${streamName}`, resultLines);
            this.emitLines(streamName, resultLines);
          } else {
            const currentPortion = cutSuffix(lines[0], MAX_LINE_PORTION_LENGTH);

            if (this.lastLinePortion[streamName].length + currentPortion.length > MAX_LINE_PORTION_LENGTH) {
              this.lastLinePortion[streamName] = currentPortion;
            } else {
              this.lastLinePortion[streamName] += currentPortion;
            }
          }
        }
      };

      this.proc.on('error', err => {
        var _this$proc, _this$proc2, _this$proc3;

        (_this$proc = this.proc) === null || _this$proc === void 0 ? void 0 : _this$proc.removeAllListeners('exit');
        (_this$proc2 = this.proc) === null || _this$proc2 === void 0 ? void 0 : _this$proc2.kill('SIGINT');

        if (err.code === 'ENOENT') {
          var _this$opts;

          err = (0, _helpers.formatEnoent)(err, this.cmd, (_this$opts = this.opts) === null || _this$opts === void 0 ? void 0 : _this$opts.cwd);
        }

        reject(err);
        (_this$proc3 = this.proc) === null || _this$proc3 === void 0 ? void 0 : _this$proc3.unref();
        this.proc = null;
      });

      if (this.proc.stdout) {
        this.proc.stdout.on('data', chunk => handleOutput({
          stdout: chunk.toString(),
          stderr: ''
        }));
      }

      if (this.proc.stderr) {
        this.proc.stderr.on('data', chunk => handleOutput({
          stdout: '',
          stderr: chunk.toString()
        }));
      }

      this.proc.on('exit', (code, signal) => {
        this.handleLastLines();
        this.emit('exit', code, signal);
        let event = this.expectingExit ? 'stop' : 'die';

        if (!this.expectingExit && code === 0) {
          event = 'end';
        }

        this.emit(event, code, signal);
        this.proc = null;
        this.expectingExit = false;
      });

      if (!startDetector) {
        setTimeout(() => {
          resolve();
        }, startDelay);
      }

      if (_lodash.default.isNumber(timeoutMs)) {
        setTimeout(() => {
          reject(new Error(`The process did not start within ${timeoutMs}ms ` + `(cmd: '${this.rep}')`));
        }, timeoutMs);
      }
    }).finally(() => {
      if (detach && this.proc) {
        this.proc.unref();
      }
    });
  }

  handleLastLines() {
    for (let stream of ['stdout', 'stderr']) {
      if (this.lastLinePortion[stream]) {
        const lastLines = [this.lastLinePortion[stream]];
        this.emit(`lines-${stream}`, lastLines);
        this.emitLines(stream, lastLines);
        this.lastLinePortion[stream] = '';
      }
    }
  }

  async stop(signal = 'SIGTERM', timeout = 10000) {
    if (!this.isRunning) {
      throw new Error(`Can't stop process; it's not currently running (cmd: '${this.rep}')`);
    }

    this.handleLastLines();
    return await new _bluebird.default((resolve, reject) => {
      var _this$proc4, _this$proc5;

      (_this$proc4 = this.proc) === null || _this$proc4 === void 0 ? void 0 : _this$proc4.on('close', resolve);
      this.expectingExit = true;
      (_this$proc5 = this.proc) === null || _this$proc5 === void 0 ? void 0 : _this$proc5.kill(signal);
      setTimeout(() => {
        reject(new Error(`Process didn't end after ${timeout}ms (cmd: '${this.rep}')`));
      }, timeout).unref();
    });
  }

  async join(allowedExitCodes = [0]) {
    if (!this.isRunning) {
      throw new Error(`Cannot join process; it is not currently running (cmd: '${this.rep}')`);
    }

    return await new _bluebird.default((resolve, reject) => {
      var _this$proc6;

      (_this$proc6 = this.proc) === null || _this$proc6 === void 0 ? void 0 : _this$proc6.on('exit', code => {
        if (code !== null && allowedExitCodes.indexOf(code) === -1) {
          reject(new Error(`Process ended with exitcode ${code} (cmd: '${this.rep}')`));
        } else {
          resolve(code);
        }
      });
    });
  }

  detachProcess() {
    if (!this.opts.detached) {
      throw new Error(`Unable to detach process that is not started with 'detached' option`);
    }

    if (this.proc) {
      this.proc.unref();
    }
  }

  get pid() {
    return this.proc ? this.proc.pid : null;
  }

}

exports.SubProcess = SubProcess;
var _default = SubProcess;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJldmVudHMiLCJNQVhfTElORV9QT1JUSU9OX0xFTkdUSCIsImN1dFN1ZmZpeCIsInN0ciIsInN1ZmZpeExlbmd0aCIsImxlbmd0aCIsInN1YnN0ciIsIlN1YlByb2Nlc3MiLCJsYXN0TGluZVBvcnRpb24iLCJwcm9jIiwiYXJncyIsImNtZCIsIm9wdHMiLCJleHBlY3RpbmdFeGl0IiwicmVwIiwiY29uc3RydWN0b3IiLCJFcnJvciIsIl8iLCJpc1N0cmluZyIsImlzQXJyYXkiLCJxdW90ZSIsInN0ZG91dCIsInN0ZGVyciIsImlzUnVubmluZyIsImVtaXRMaW5lcyIsInN0cmVhbSIsImxpbmVzIiwibGluZSIsImVtaXQiLCJ0b1VwcGVyQ2FzZSIsInN0YXJ0Iiwic3RhcnREZXRlY3RvciIsInRpbWVvdXRNcyIsImRldGFjaCIsInN0YXJ0RGVsYXkiLCJnZW5lcmljU3RhcnREZXRlY3RvciIsImlzTnVtYmVyIiwiaXNCb29sZWFuIiwiZGV0YWNoZWQiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsInNwYXduIiwic2V0RW5jb2RpbmciLCJlbmNvZGluZyIsImhhbmRsZU91dHB1dCIsInN0cmVhbXMiLCJpc0Z1bmN0aW9uIiwiZSIsInN0cmVhbU5hbWUiLCJzdHJlYW1EYXRhIiwidG9QYWlycyIsInNwbGl0IiwibWFwIiwieCIsImxhc3QiLCJyZXN1bHRMaW5lcyIsInNsaWNlIiwiY3VycmVudFBvcnRpb24iLCJvbiIsImVyciIsInJlbW92ZUFsbExpc3RlbmVycyIsImtpbGwiLCJjb2RlIiwiZm9ybWF0RW5vZW50IiwiY3dkIiwidW5yZWYiLCJjaHVuayIsInRvU3RyaW5nIiwic2lnbmFsIiwiaGFuZGxlTGFzdExpbmVzIiwiZXZlbnQiLCJzZXRUaW1lb3V0IiwiZmluYWxseSIsImxhc3RMaW5lcyIsInN0b3AiLCJ0aW1lb3V0Iiwiam9pbiIsImFsbG93ZWRFeGl0Q29kZXMiLCJpbmRleE9mIiwiZGV0YWNoUHJvY2VzcyIsInBpZCJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zdWJwcm9jZXNzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrcyAqL1xuXG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xuY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IGV2ZW50cztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZvcm1hdEVub2VudCB9IGZyb20gJy4vaGVscGVycyc7XG5cblxuLy8gVGhpcyBpcyBuZWVkZWQgdG8gYXZvaWQgbWVtb3J5IGxlYWtzXG4vLyB3aGVuIHRoZSBwcm9jZXNzIG91dHB1dCBpcyB0b28gbG9uZyBhbmQgY29udGFpbnNcbi8vIG5vIGxpbmUgYnJlYWtzXG5jb25zdCBNQVhfTElORV9QT1JUSU9OX0xFTkdUSCA9IDB4RkZGRjtcblxuZnVuY3Rpb24gY3V0U3VmZml4IChzdHIsIHN1ZmZpeExlbmd0aCkge1xuICByZXR1cm4gc3RyLmxlbmd0aCA+IHN1ZmZpeExlbmd0aFxuICAgIC8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTI4NjlcbiAgICA/IGAgJHtzdHIuc3Vic3RyKHN0ci5sZW5ndGggLSBzdWZmaXhMZW5ndGgpfWAuc3Vic3RyKDEpXG4gICAgOiBzdHI7XG59XG5cblxuY2xhc3MgU3ViUHJvY2VzcyBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG5cbiAgLyoqXG4gICAqIEB0eXBlIHsge3N0ZG91dDogc3RyaW5nLCBzdGRlcnI6IHN0cmluZ30gfVxuICAgKi9cbiAgbGFzdExpbmVQb3J0aW9uO1xuXG4gIC8qKiBAdHlwZSB7aW1wb3J0KCdjaGlsZF9wcm9jZXNzJykuQ2hpbGRQcm9jZXNzP30gKi9cbiAgcHJvYztcblxuICAvKiogQHR5cGUge3N0cmluZ1tdfSAqL1xuICBhcmdzO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgKi9cbiAgY21kO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7YW55fVxuICAqL1xuICBvcHRzO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICovXG4gIGV4cGVjdGluZ0V4aXQ7XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtzdHJpbmd9XG4gICAqL1xuICByZXA7XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjbWRcbiAgICogQHBhcmFtIHtzdHJpbmdbXX0gW2FyZ3NdXG4gICAqIEBwYXJhbSB7YW55fSBbb3B0c11cbiAgICovXG4gIGNvbnN0cnVjdG9yIChjbWQsIGFyZ3MgPSBbXSwgb3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoIWNtZCkgdGhyb3cgbmV3IEVycm9yKCdDb21tYW5kIGlzIHJlcXVpcmVkJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICBpZiAoIV8uaXNTdHJpbmcoY21kKSkgdGhyb3cgbmV3IEVycm9yKCdDb21tYW5kIG11c3QgYmUgYSBzdHJpbmcnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIGlmICghXy5pc0FycmF5KGFyZ3MpKSB0aHJvdyBuZXcgRXJyb3IoJ0FyZ3MgbXVzdCBiZSBhbiBhcnJheScpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgICB0aGlzLmNtZCA9IGNtZDtcbiAgICB0aGlzLmFyZ3MgPSBhcmdzO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgdGhpcy5vcHRzID0gb3B0cztcbiAgICB0aGlzLmV4cGVjdGluZ0V4aXQgPSBmYWxzZTtcblxuICAgIC8vIGdldCBhIHF1b3RlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgY29tbWFuZCBmb3IgZXJyb3Igc3RyaW5nc1xuICAgIHRoaXMucmVwID0gcXVvdGUoW2NtZCwgLi4uYXJnc10pO1xuXG4gICAgdGhpcy5sYXN0TGluZVBvcnRpb24gPSB7c3Rkb3V0OiAnJywgc3RkZXJyOiAnJ307XG4gIH1cblxuICBnZXQgaXNSdW5uaW5nICgpIHtcbiAgICAvLyBwcmVzZW5jZSBvZiBgcHJvY2AgbWVhbnMgd2UgaGF2ZSBjb25uZWN0ZWQgYW5kIHN0YXJ0ZWRcbiAgICByZXR1cm4gISF0aGlzLnByb2M7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmVhbVxuICAgKiBAcGFyYW0ge0l0ZXJhYmxlPHN0cmluZz59IGxpbmVzXG4gICAqL1xuICBlbWl0TGluZXMgKHN0cmVhbSwgbGluZXMpIHtcbiAgICBmb3IgKGxldCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICB0aGlzLmVtaXQoJ3N0cmVhbS1saW5lJywgYFske3N0cmVhbS50b1VwcGVyQ2FzZSgpfV0gJHtsaW5lfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIHNwYXduIHRoZSBzdWJwcm9jZXNzIGFuZCByZXR1cm4gY29udHJvbCB3aGVuZXZlciB3ZSBkZWVtIHRoYXQgaXQgaGFzIGZ1bGx5XG4gIC8vIFwic3RhcnRlZFwiXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0ge1N0YXJ0RGV0ZWN0b3J8bnVtYmVyP30gc3RhcnREZXRlY3RvclxuICAgKiBAcGFyYW0ge251bWJlcj99IHRpbWVvdXRNc1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRldGFjaFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAgICovXG4gIGFzeW5jIHN0YXJ0IChzdGFydERldGVjdG9yID0gbnVsbCwgdGltZW91dE1zID0gbnVsbCwgZGV0YWNoID0gZmFsc2UpIHtcbiAgICBsZXQgc3RhcnREZWxheSA9IDEwO1xuXG4gICAgY29uc3QgZ2VuZXJpY1N0YXJ0RGV0ZWN0b3IgPSAvKiogQHR5cGUge1N0YXJ0RGV0ZWN0b3J9ICovKGZ1bmN0aW9uIGdlbmVyaWNTdGFydERldGVjdG9yIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgcmV0dXJuIHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgfSk7XG5cbiAgICAvLyB0aGUgZGVmYXVsdCBzdGFydCBkZXRlY3RvciBzaW1wbHkgcmV0dXJucyB0cnVlIHdoZW4gd2UgZ2V0IGFueSBvdXRwdXRcbiAgICBpZiAoc3RhcnREZXRlY3RvciA9PT0gbnVsbCkge1xuICAgICAgc3RhcnREZXRlY3RvciA9IGdlbmVyaWNTdGFydERldGVjdG9yO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSB1c2VyIHBhc3NlcyBhIG51bWJlciwgdGhlbiB3ZSBzaW1wbHkgZGVsYXkgYSBjZXJ0YWluIGFtb3VudCBvZlxuICAgIC8vIHRpbWUgYmVmb3JlIHJldHVybmluZyBjb250cm9sLCByYXRoZXIgdGhhbiB3YWl0aW5nIGZvciBhIGNvbmRpdGlvblxuICAgIGlmIChfLmlzTnVtYmVyKHN0YXJ0RGV0ZWN0b3IpKSB7XG4gICAgICBzdGFydERlbGF5ID0gc3RhcnREZXRlY3RvcjtcbiAgICAgIHN0YXJ0RGV0ZWN0b3IgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSB1c2VyIHBhc3NlcyBpbiBhIGJvb2xlYW4gYXMgb25lIG9mIHRoZSBhcmd1bWVudHMsIHVzZSBpdCBmb3IgYGRldGFjaGBcbiAgICBpZiAoXy5pc0Jvb2xlYW4oc3RhcnREZXRlY3RvcikgJiYgc3RhcnREZXRlY3Rvcikge1xuICAgICAgaWYgKCF0aGlzLm9wdHMuZGV0YWNoZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZGV0YWNoIHByb2Nlc3MgdGhhdCBpcyBub3Qgc3RhcnRlZCB3aXRoICdkZXRhY2hlZCcgb3B0aW9uYCk7XG4gICAgICB9XG4gICAgICBkZXRhY2ggPSB0cnVlO1xuICAgICAgc3RhcnREZXRlY3RvciA9IGdlbmVyaWNTdGFydERldGVjdG9yO1xuICAgIH0gZWxzZSBpZiAoXy5pc0Jvb2xlYW4odGltZW91dE1zKSAmJiB0aW1lb3V0TXMpIHtcbiAgICAgIGlmICghdGhpcy5vcHRzLmRldGFjaGVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGRldGFjaCBwcm9jZXNzIHRoYXQgaXMgbm90IHN0YXJ0ZWQgd2l0aCAnZGV0YWNoZWQnIG9wdGlvbmApO1xuICAgICAgfVxuICAgICAgZGV0YWNoID0gdHJ1ZTtcbiAgICAgIHRpbWVvdXRNcyA9IG51bGw7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIGEgcHJvbWlzZSBzbyB3ZSBjYW4gd3JhcCB0aGUgYXN5bmMgYmVoYXZpb3JcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gYWN0dWFsbHkgc3Bhd24gdGhlIHN1YnByb2NcbiAgICAgIHRoaXMucHJvYyA9IHNwYXduKHRoaXMuY21kLCB0aGlzLmFyZ3MsIHRoaXMub3B0cyk7XG5cbiAgICAgIGlmICh0aGlzLnByb2Muc3Rkb3V0KSB7XG4gICAgICAgIHRoaXMucHJvYy5zdGRvdXQuc2V0RW5jb2RpbmcodGhpcy5vcHRzLmVuY29kaW5nIHx8ICd1dGY4Jyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wcm9jLnN0ZGVycikge1xuICAgICAgICB0aGlzLnByb2Muc3RkZXJyLnNldEVuY29kaW5nKHRoaXMub3B0cy5lbmNvZGluZyB8fCAndXRmOCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5sYXN0TGluZVBvcnRpb24gPSB7c3Rkb3V0OiAnJywgc3RkZXJyOiAnJ307XG5cbiAgICAgIC8vIHRoaXMgZnVuY3Rpb24gaGFuZGxlcyBvdXRwdXQgdGhhdCB3ZSBjb2xsZWN0IGZyb20gdGhlIHN1YnByb2NcbiAgICAgIC8qKlxuICAgICAgICpcbiAgICAgICAqIEBwYXJhbSB7IHtzdGRvdXQ6IHN0cmluZywgc3RkZXJyOiBzdHJpbmd9IH0gc3RyZWFtc1xuICAgICAgICovXG4gICAgICBjb25zdCBoYW5kbGVPdXRwdXQgPSAoc3RyZWFtcykgPT4ge1xuICAgICAgICBjb25zdCB7c3Rkb3V0LCBzdGRlcnJ9ID0gc3RyZWFtcztcbiAgICAgICAgLy8gaWYgd2UgaGF2ZSBhIHN0YXJ0RGV0ZWN0b3IsIHJ1biBpdCBvbiB0aGUgb3V0cHV0IHNvIHdlIGNhbiByZXNvbHZlL1xuICAgICAgICAvLyByZWplY3QgYW5kIG1vdmUgb24gZnJvbSBzdGFydFxuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24oc3RhcnREZXRlY3RvcikgJiYgc3RhcnREZXRlY3RvcihzdGRvdXQsIHN0ZGVycikpIHtcbiAgICAgICAgICAgIHN0YXJ0RGV0ZWN0b3IgPSBudWxsO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGVtaXQgdGhlIGFjdHVhbCBvdXRwdXQgZm9yIHdob21ldmVyJ3MgbGlzdGVuaW5nXG4gICAgICAgIHRoaXMuZW1pdCgnb3V0cHV0Jywgc3Rkb3V0LCBzdGRlcnIpO1xuXG4gICAgICAgIC8vIHdlIGFsc28gd2FudCB0byBlbWl0IGxpbmVzLCBidXQgaXQncyBtb3JlIGNvbXBsZXggc2luY2Ugb3V0cHV0XG4gICAgICAgIC8vIGNvbWVzIGluIGNodW5rcyBhbmQgYSBsaW5lIGNvdWxkIGNvbWUgaW4gdHdvIGRpZmZlcmVudCBjaHVua3MsIHNvXG4gICAgICAgIC8vIHdlIGhhdmUgbG9naWMgdG8gaGFuZGxlIHRoYXQgY2FzZSAodXNpbmcgdGhpcy5sYXN0TGluZVBvcnRpb24gdG9cbiAgICAgICAgLy8gcmVtZW1iZXIgYSBsaW5lIHRoYXQgc3RhcnRlZCBidXQgZGlkIG5vdCBmaW5pc2ggaW4gdGhlIGxhc3QgY2h1bmspXG4gICAgICAgIGZvciAoY29uc3QgW3N0cmVhbU5hbWUsIHN0cmVhbURhdGFdIG9mIC8qKiBAdHlwZSB7W1snc3Rkb3V0Jywgc3RyaW5nXSwgWydzdGRlcnInLCBzdHJpbmddXX0gKi8oXy50b1BhaXJzKHN0cmVhbXMpKSkge1xuICAgICAgICAgIGlmICghc3RyZWFtRGF0YSkgY29udGludWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgICAgICBjb25zdCBsaW5lcyA9IHN0cmVhbURhdGEuc3BsaXQoJ1xcbicpXG4gICAgICAgICAgICAvLyBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvdjgvaXNzdWVzL2RldGFpbD9pZD0yODY5XG4gICAgICAgICAgICAubWFwKCh4KSA9PiBgICR7eH1gLnN1YnN0cigxKSk7XG4gICAgICAgICAgaWYgKGxpbmVzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIGxpbmVzWzBdID0gdGhpcy5sYXN0TGluZVBvcnRpb25bc3RyZWFtTmFtZV0gKyBsaW5lc1swXTtcbiAgICAgICAgICAgIHRoaXMubGFzdExpbmVQb3J0aW9uW3N0cmVhbU5hbWVdID0gY3V0U3VmZml4KF8ubGFzdChsaW5lcyksIE1BWF9MSU5FX1BPUlRJT05fTEVOR1RIKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdExpbmVzID0gbGluZXMuc2xpY2UoMCwgLTEpO1xuICAgICAgICAgICAgdGhpcy5lbWl0KGBsaW5lcy0ke3N0cmVhbU5hbWV9YCwgcmVzdWx0TGluZXMpO1xuICAgICAgICAgICAgdGhpcy5lbWl0TGluZXMoc3RyZWFtTmFtZSwgcmVzdWx0TGluZXMpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50UG9ydGlvbiA9IGN1dFN1ZmZpeChsaW5lc1swXSwgTUFYX0xJTkVfUE9SVElPTl9MRU5HVEgpO1xuICAgICAgICAgICAgaWYgKHRoaXMubGFzdExpbmVQb3J0aW9uW3N0cmVhbU5hbWVdLmxlbmd0aCArIGN1cnJlbnRQb3J0aW9uLmxlbmd0aCA+IE1BWF9MSU5FX1BPUlRJT05fTEVOR1RIKSB7XG4gICAgICAgICAgICAgIHRoaXMubGFzdExpbmVQb3J0aW9uW3N0cmVhbU5hbWVdID0gY3VycmVudFBvcnRpb247XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aGlzLmxhc3RMaW5lUG9ydGlvbltzdHJlYW1OYW1lXSArPSBjdXJyZW50UG9ydGlvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIC8vIGlmIHdlIGdldCBhbiBlcnJvciBzcGF3bmluZyB0aGUgcHJvYywgcmVqZWN0IGFuZCBjbGVhbiB1cCB0aGUgcHJvY1xuICAgICAgdGhpcy5wcm9jLm9uKCdlcnJvcicsIC8qKiBAcGFyYW0ge05vZGVKUy5FcnJub0V4Y2VwdGlvbn0gZXJyICovIChlcnIpID0+IHtcbiAgICAgICAgdGhpcy5wcm9jPy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4aXQnKTtcbiAgICAgICAgdGhpcy5wcm9jPy5raWxsKCdTSUdJTlQnKTtcblxuICAgICAgICBpZiAoZXJyLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgZXJyID0gZm9ybWF0RW5vZW50KGVyciwgdGhpcy5jbWQsIHRoaXMub3B0cz8uY3dkKTtcbiAgICAgICAgfVxuICAgICAgICByZWplY3QoZXJyKTtcblxuICAgICAgICB0aGlzLnByb2M/LnVucmVmKCk7XG4gICAgICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgICB9KTtcblxuICAgICAgaWYgKHRoaXMucHJvYy5zdGRvdXQpIHtcbiAgICAgICAgdGhpcy5wcm9jLnN0ZG91dC5vbignZGF0YScsIChjaHVuaykgPT4gaGFuZGxlT3V0cHV0KHtzdGRvdXQ6IGNodW5rLnRvU3RyaW5nKCksIHN0ZGVycjogJyd9KSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnByb2Muc3RkZXJyKSB7XG4gICAgICAgIHRoaXMucHJvYy5zdGRlcnIub24oJ2RhdGEnLCAoY2h1bmspID0+IGhhbmRsZU91dHB1dCh7c3Rkb3V0OiAnJywgc3RkZXJyOiBjaHVuay50b1N0cmluZygpfSkpO1xuICAgICAgfVxuXG4gICAgICAvLyB3aGVuIHRoZSBwcm9jIGV4aXRzLCB3ZSBtaWdodCBzdGlsbCBoYXZlIGEgYnVmZmVyIG9mIGxpbmVzIHdlIHdlcmVcbiAgICAgIC8vIHdhaXRpbmcgb24gbW9yZSBjaHVua3MgdG8gY29tcGxldGUuIEdvIGFoZWFkIGFuZCBlbWl0IHRob3NlLCB0aGVuXG4gICAgICAvLyByZS1lbWl0IHRoZSBleGl0IHNvIGEgbGlzdGVuZXIgY2FuIGhhbmRsZSB0aGUgcG9zc2libHktdW5leHBlY3RlZCBleGl0XG4gICAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlTGFzdExpbmVzKCk7XG5cbiAgICAgICAgdGhpcy5lbWl0KCdleGl0JywgY29kZSwgc2lnbmFsKTtcblxuICAgICAgICAvLyBpbiBhZGRpdGlvbiB0byB0aGUgYmFyZSBleGl0IGV2ZW50LCBhbHNvIGVtaXQgb25lIG9mIHRocmVlIG90aGVyXG4gICAgICAgIC8vIGV2ZW50cyB0aGF0IGNvbnRhaW4gbW9yZSBoZWxwZnVsIGluZm9ybWF0aW9uOlxuICAgICAgICAvLyAnc3RvcCc6IHdlIHN0b3BwZWQgdGhpc1xuICAgICAgICAvLyAnZGllJzogdGhlIHByb2Nlc3MgZW5kZWQgb3V0IG9mIG91ciBjb250cm9sIHdpdGggYSBub24temVybyBleGl0XG4gICAgICAgIC8vICdlbmQnOiB0aGUgcHJvY2VzcyBlbmRlZCBvdXQgb2Ygb3VyIGNvbnRyb2wgd2l0aCBhIHplcm8gZXhpdFxuICAgICAgICBsZXQgZXZlbnQgPSB0aGlzLmV4cGVjdGluZ0V4aXQgPyAnc3RvcCcgOiAnZGllJztcbiAgICAgICAgaWYgKCF0aGlzLmV4cGVjdGluZ0V4aXQgJiYgY29kZSA9PT0gMCkge1xuICAgICAgICAgIGV2ZW50ID0gJ2VuZCc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbWl0KGV2ZW50LCBjb2RlLCBzaWduYWwpO1xuXG4gICAgICAgIC8vIGZpbmFsbHkgY2xlYW4gdXAgdGhlIHByb2MgYW5kIG1ha2Ugc3VyZSB0byByZXNldCBvdXIgZXhpdFxuICAgICAgICAvLyBleHBlY3RhdGlvbnNcbiAgICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgICAgdGhpcy5leHBlY3RpbmdFeGl0ID0gZmFsc2U7XG4gICAgICB9KTtcblxuICAgICAgLy8gaWYgdGhlIHVzZXIgaGFzbid0IGdpdmVuIHVzIGEgc3RhcnREZXRlY3RvciwgaW5zdGVhZCBqdXN0IHJlc29sdmVcbiAgICAgIC8vIHdoZW4gc3RhcnREZWxheSBtcyBoYXZlIHBhc3NlZFxuICAgICAgaWYgKCFzdGFydERldGVjdG9yKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyByZXNvbHZlKCk7IH0sIHN0YXJ0RGVsYXkpO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGUgdXNlciBoYXMgZ2l2ZW4gdXMgYSB0aW1lb3V0LCBzdGFydCB0aGUgY2xvY2sgZm9yIHJlamVjdGluZ1xuICAgICAgLy8gdGhlIHByb21pc2UgaWYgd2UgdGFrZSB0b28gbG9uZyB0byBzdGFydFxuICAgICAgaWYgKF8uaXNOdW1iZXIodGltZW91dE1zKSkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBUaGUgcHJvY2VzcyBkaWQgbm90IHN0YXJ0IHdpdGhpbiAke3RpbWVvdXRNc31tcyBgICtcbiAgICAgICAgICAgIGAoY21kOiAnJHt0aGlzLnJlcH0nKWApKTtcbiAgICAgICAgfSwgdGltZW91dE1zKTtcbiAgICAgIH1cbiAgICB9KS5maW5hbGx5KCgpID0+IHtcbiAgICAgIGlmIChkZXRhY2ggJiYgdGhpcy5wcm9jKSB7XG4gICAgICAgIHRoaXMucHJvYy51bnJlZigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlTGFzdExpbmVzICgpIHtcbiAgICBmb3IgKGxldCBzdHJlYW0gb2YgWydzdGRvdXQnLCAnc3RkZXJyJ10pIHtcbiAgICAgIGlmICh0aGlzLmxhc3RMaW5lUG9ydGlvbltzdHJlYW1dKSB7XG4gICAgICAgIGNvbnN0IGxhc3RMaW5lcyA9IFt0aGlzLmxhc3RMaW5lUG9ydGlvbltzdHJlYW1dXTtcbiAgICAgICAgdGhpcy5lbWl0KGBsaW5lcy0ke3N0cmVhbX1gLCBsYXN0TGluZXMpO1xuICAgICAgICB0aGlzLmVtaXRMaW5lcyhzdHJlYW0sIGxhc3RMaW5lcyk7XG4gICAgICAgIHRoaXMubGFzdExpbmVQb3J0aW9uW3N0cmVhbV0gPSAnJztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHtOb2RlSlMuU2lnbmFsc30gc2lnbmFsXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lb3V0XG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgKi9cbiAgYXN5bmMgc3RvcCAoc2lnbmFsID0gJ1NJR1RFUk0nLCB0aW1lb3V0ID0gMTAwMDApIHtcbiAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IHN0b3AgcHJvY2VzczsgaXQncyBub3QgY3VycmVudGx5IHJ1bm5pbmcgKGNtZDogJyR7dGhpcy5yZXB9JylgKTtcbiAgICB9XG4gICAgLy8gbWFrZSBzdXJlIHRvIGVtaXQgYW55IGRhdGEgaW4gb3VyIGxpbmVzIGJ1ZmZlciB3aGVuZXZlciB3ZSdyZSBkb25lIHdpdGhcbiAgICAvLyB0aGUgcHJvY1xuICAgIHRoaXMuaGFuZGxlTGFzdExpbmVzKCk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMucHJvYz8ub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgICB0aGlzLmV4cGVjdGluZ0V4aXQgPSB0cnVlO1xuICAgICAgdGhpcy5wcm9jPy5raWxsKHNpZ25hbCk7XG4gICAgICAvLyB0aGlzIHRpbWVvdXQgbmVlZHMgdW5yZWYoKSBvciBub2RlIHdpbGwgd2FpdCBmb3IgdGhlIHRpbWVvdXQgdG8gZmlyZSBiZWZvcmVcbiAgICAgIC8vIGV4aXRpbmcgdGhlIHByb2Nlc3MuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyICR7dGltZW91dH1tcyAoY21kOiAnJHt0aGlzLnJlcH0nKWApKTtcbiAgICAgIH0sIHRpbWVvdXQpLnVucmVmKCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBqb2luIChhbGxvd2VkRXhpdENvZGVzID0gWzBdKSB7XG4gICAgaWYgKCF0aGlzLmlzUnVubmluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgam9pbiBwcm9jZXNzOyBpdCBpcyBub3QgY3VycmVudGx5IHJ1bm5pbmcgKGNtZDogJyR7dGhpcy5yZXB9JylgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5wcm9jPy5vbignZXhpdCcsIChjb2RlKSA9PiB7XG4gICAgICAgIGlmIChjb2RlICE9PSBudWxsICYmIGFsbG93ZWRFeGl0Q29kZXMuaW5kZXhPZihjb2RlKSA9PT0gLTEpIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBQcm9jZXNzIGVuZGVkIHdpdGggZXhpdGNvZGUgJHtjb2RlfSAoY21kOiAnJHt0aGlzLnJlcH0nKWApKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKGNvZGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qXG4gICAqIFRoaXMgd2lsbCBvbmx5IHdvcmsgaWYgdGhlIHByb2Nlc3MgaXMgY3JlYXRlZCB3aXRoIHRoZSBgZGV0YWNoZWRgIG9wdGlvblxuICAgKi9cbiAgZGV0YWNoUHJvY2VzcyAoKSB7XG4gICAgaWYgKCF0aGlzLm9wdHMuZGV0YWNoZWQpIHtcbiAgICAgIC8vIHRoaXMgbWVhbnMgdGhhdCB0aGVyZSBpcyBhIG1pc2NvbmZpZ3VyYXRpb24gaW4gdGhlIGNhbGxpbmcgY29kZVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZGV0YWNoIHByb2Nlc3MgdGhhdCBpcyBub3Qgc3RhcnRlZCB3aXRoICdkZXRhY2hlZCcgb3B0aW9uYCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgIHRoaXMucHJvYy51bnJlZigpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBwaWQgKCkge1xuICAgIHJldHVybiB0aGlzLnByb2MgPyB0aGlzLnByb2MucGlkIDogbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgeyBTdWJQcm9jZXNzIH07XG5leHBvcnQgZGVmYXVsdCBTdWJQcm9jZXNzO1xuXG4vKipcbiAqIEBjYWxsYmFjayBTdGFydERldGVjdG9yXG4gKiBAcGFyYW0ge3N0cmluZ30gc3Rkb3V0XG4gKiBAcGFyYW0ge3N0cmluZ30gW3N0ZGVycl1cbiAqIEByZXR1cm5zIHthbnl9XG4gKi9cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFKQSxNQUFNO0VBQUVBO0FBQUYsSUFBbUJDLGVBQXpCO0FBVUEsTUFBTUMsdUJBQXVCLEdBQUcsTUFBaEM7O0FBRUEsU0FBU0MsU0FBVCxDQUFvQkMsR0FBcEIsRUFBeUJDLFlBQXpCLEVBQXVDO0VBQ3JDLE9BQU9ELEdBQUcsQ0FBQ0UsTUFBSixHQUFhRCxZQUFiLEdBRUYsSUFBR0QsR0FBRyxDQUFDRyxNQUFKLENBQVdILEdBQUcsQ0FBQ0UsTUFBSixHQUFhRCxZQUF4QixDQUFzQyxFQUExQyxDQUE0Q0UsTUFBNUMsQ0FBbUQsQ0FBbkQsQ0FGRyxHQUdISCxHQUhKO0FBSUQ7O0FBR0QsTUFBTUksVUFBTixTQUF5QlIsWUFBekIsQ0FBc0M7RUFLcENTLGVBQWU7RUFHZkMsSUFBSTtFQUdKQyxJQUFJO0VBS0pDLEdBQUc7RUFLSEMsSUFBSTtFQUtKQyxhQUFhO0VBS2JDLEdBQUc7O0VBT0hDLFdBQVcsQ0FBRUosR0FBRixFQUFPRCxJQUFJLEdBQUcsRUFBZCxFQUFrQkUsSUFBSSxH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